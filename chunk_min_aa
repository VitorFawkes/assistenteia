import"jsr:@supabase/functions-js/edge-runtime.d.ts";import{createClient as $e}from"jsr:@supabase/supabase-js@2";function ee(b,D,d){let $=b.due_at||null;if(b.time_config){const{mode:c}=b.time_config,m=new Date(D.getTime());if(console.log(`\u{1F9E0} TIME CONFIG RECEIVED: Mode = ${c} `,b.time_config),c==="relative"){const{relative_amount:v,relative_unit:q}=b.time_config;v&&q&&(q==="minutes"?m.setMinutes(m.getMinutes()+v):q==="hours"?m.setHours(m.getHours()+v):q==="days"&&m.setDate(m.getDate()+v),$=m.toISOString().replace("Z","-03:00"))}else if(c==="absolute"){const{target_day:v,target_month:q,target_year:T,target_hour:B,target_minute:P}=b.time_config;T&&m.setFullYear(T),q&&m.setMonth(q-1),v&&m.setDate(v),B!==void 0?m.setHours(B):m.setHours(9),P!==void 0?m.setMinutes(P):m.setMinutes(0),$=m.toISOString().replace("Z","-03:00")}}else if(b.relative_time&&b.relative_time.amount){const{amount:c,unit:m}=b.relative_time,v=new Date(D.getTime());m==="minutes"?v.setMinutes(v.getMinutes()+c):m==="hours"?v.setHours(v.getHours()+c):m==="days"&&v.setDate(v.getDate()+c),$=v.toISOString().replace("Z","-03:00")}else d&&($=d);return $}Deno.serve(async b=>{if(b.method==="OPTIONS")return new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"authorization, x-client-info, apikey, content-type"}});try{const{content:D,mediaUrl:d,mediaType:$,userId:c,messageId:m,is_owner:v,sender_name:q,sender_number:T,is_group:B,group_name:P}=await b.json();console.log(`\u{1F680} Process Message HIT: ${D?.substring(0,50)}...`);const ge=Deno.env.get("SUPABASE_URL"),fe=Deno.env.get("SUPABASE_SERVICE_ROLE_KEY"),r=$e(ge,fe),F=Deno.env.get("OPENAI_API_KEY");if(!F)return new Response(JSON.stringify({success:!1,error:"OpenAI API key not configured"}),{status:500,headers:{"Content-Type":"application/json"}});let I=D||"";const J=v!==!1,te=q||"Desconhecido",Oe=`
CONTEXTO ATUAL:
- Data/Hora: ${new Date().toISOString()}
- Usu\xE1rio: ${c}
- Canal: WhatsApp ${B?"(GRUPO)":"(PRIVADO)"}
- Remetente da Mensagem: ${q||"Desconhecido"} (${T||"?"})
- Voc\xEA \xE9 o Dono? ${J?"SIM":"N\xC3O"}
`;console.log(`\u{1F464} Sender: ${te} (${T||"?"}) | Is Owner: ${J}`);const{data:oe}=await r.from("user_settings").select("phone_number, ai_name").eq("user_id",c).single(),ne=oe?.phone_number||"",_e=oe?.ai_name||"Assistente";if(J){const p=T?.replace(/\D/g,"")||"",g=ne.replace(/\D/g,""),O=p===g,S=D?.toLowerCase().match(/\b(bibi|ia|bot|assistente)\b/);if(!O&&!S)return console.log(`\u{1F6D1} Outgoing message to ${p} ignored (No trigger).`),new Response(JSON.stringify({success:!0,message:"Outgoing message ignored (No trigger)",skipped:!0}),{headers:{"Content-Type":"application/json"}})}else return console.log("\u{1F6D1} Economy Mode: Message from non-owner. Skipping AI processing to save tokens."),new Response(JSON.stringify({success:!0,message:"Message saved but not processed (Economy Mode)",skipped:!0}),{headers:{"Content-Type":"application/json"}});console.log("\u{1F4DD} Initial content received:",I||"EMPTY");const Y=[{type:"function",function:{name:"manage_collections",description:"Gerencia cole\xE7\xF5es (criar ou listar)",parameters:{type:"object",properties:{action:{type:"string",enum:["create","list","update","delete"],description:"A\xE7\xE3o a realizar"},name:{type:"string",description:"Nome da pasta/cole\xE7\xE3o"},description:{type:"string",description:"Descri\xE7\xE3o opcional"},icon:{type:"string",description:"Emoji para \xEDcone (ex: \u2708\uFE0F, \u{1F3E0})"},new_name:{type:"string",description:"Novo nome (para update)"},force:{type:"boolean",description:"For\xE7ar dele\xE7\xE3o se n\xE3o vazia"},entity_type:{type:"string",enum:["trip","project","finance_bucket","event_list","generic"],description:"Tipo da entidade (OBRIGAT\xD3RIO na cria\xE7\xE3o)"},metadata:{type:"object",description:'Dados espec\xEDficos do tipo (ex: { status: "planning" } para viagens, { currency: "BRL" } para financeiro).',properties:{status:{type:"string",enum:["planning","confirmed","completed"],description:"Status da viagem (Obrigat\xF3rio para trip)"},currency:{type:"string",enum:["BRL","USD","EUR"],description:"Moeda (Obrigat\xF3rio para finance_bucket)"}}}},required:["action"]}}},{type:"function",function:{name:"migrate_legacy_collections",description:"ADMIN ONLY: Migra cole\xE7\xF5es antigas (sem entity_type) para o novo esquema de governan\xE7a.",parameters:{type:"object",properties:{limit:{type:"number",description:"Quantas cole\xE7\xF5es processar por vez (padr\xE3o 5)"},dry_run:{type:"boolean",description:"Se true, apenas simula e mostra o que faria"}}}}},{type:"function",function:{name:"manage_financials",description:"Gerencia GASTOS e RECEITAS. Use para tudo que envolve dinheiro (compras, contas, or\xE7amentos).",parameters:{type:"object",properties:{action:{type:"string",enum:["add","list","delete"],description:"A\xE7\xE3o"},collection_name:{type:"string",description:'Nome da cole\xE7\xE3o (ex: "Viagem Paris", "Obras", "Finan\xE7as")'},amount:{type:"number",description:"Valor monet\xE1rio (OBRIGAT\xD3RIO). Use ponto para decimais."},description:{type:"string",description:'Descri\xE7\xE3o do gasto (ex: "Uber", "Jantar")'},category:{type:"string",description:'Categoria para agrupar (ex: "Transporte", "Alimenta\xE7\xE3o")'},date:{type:"string",description:"Data do gasto (ISO). Se omitido, usa hoje."}},required:["action","collection_name"]}}},{type:"function",function:{name:"manage_credentials",description:"Gerencia SENHAS, C\xD3DIGOS e DADOS SENS\xCDVEIS. Seguran\xE7a m\xE1xima.",parameters:{type:"object",properties:{action:{type:"string",enum:["add","list","delete"],description:"A\xE7\xE3o"},collection_name:{type:"string",description:'Nome da cole\xE7\xE3o (ex: "Senhas", "C\xF3digos", "Seguran\xE7a")'},service_name:{type:"string",description:'Nome do servi\xE7o (ex: "Netflix", "Alarme")'},username:{type:"string",description:"Login ou usu\xE1rio"},password:{type:"string",description:"A senha ou c\xF3digo secreto"},url:{type:"string",description:"Link de acesso"},notes:{type:"string",description:"Obs adicionais"}},required:["action","collection_name"]}}},{type:"function",function:{name:"manage_inventory",description:"Gerencia LISTAS DE ITENS (Malas, Compras, Livros, Filmes). Suporta m\xFAltiplos itens de uma vez.",parameters:{type:"object",properties:{action:{type:"string",enum:["add","list","delete"],description:"A\xE7\xE3o"},collection_name:{type:"string",description:'Nome da cole\xE7\xE3o (ex: "Mala", "Mercado")'},items:{type:"array",description:"Lista de itens para adicionar.",items:{type:"object",properties:{content:{type:"string",description:'Nome do item (ex: "Arroz", "Casaco")'},quantity:{type:"string",description:'Quantidade (ex: "2kg")'},category:{type:"string",description:'Categoria visual (ex: "Higiene", "Carnes")'},checked:{type:"boolean",description:"Se j\xE1 est\xE1 feito/comprado"},notes:{type:"string",description:"Detalhes extras"}},required:["content"]}}},required:["action","collection_name","items"]}}},{type:"function",function:{name:"manage_items",description:"LEGADO/GEN\xC9RICO: Use APENAS para notas simples ou textos que N\xC3O se encaixam em Financeiro, Credenciais ou Listas.",parameters:{type:"object",properties:{action:{type:"string",enum:["list","add","update","delete"]},collection_name:{type:"string"},content:{type:"string"},metadata:{type:"object",description:"Metadados gen\xE9ricos"}},required:["action","collection_name"]}}},{type:"function",function:{name:"manage_monitors",description:'Use para MONITORAR conversas e avisar o usu\xE1rio quando algo espec\xEDfico acontecer (ex: "me avise quando mandarem a planilha").',parameters:{type:"object",properties:{action:{type:"string",enum:["create","list","delete"]},keyword:{type:"string",description:"Palavra-chave ou frase para buscar"},chat_name:{type:"string",description:"Nome do grupo/chat para monitorar (opcional, null = todos)"},frequency:{type:"string",enum:["once","always","ask"],description:"once=avisar 1 vez e parar. always=sempre avisar. ask=perguntar se deve parar."}},required:["action"]}}},{type:"function",function:{name:"query_data",description:"Consulta dados avan\xE7ada com filtros e agrega\xE7\xF5es",parameters:{type:"object",properties:{collection_name:{type:"string",description:"Nome da cole\xE7\xE3o"},operation:{type:"string",enum:["list","sum","count","average"],description:"Opera\xE7\xE3o"},start_date:{type:"string",description:"Data inicial (ISO) para filtrar por metadata.date ou created_at"},end_date:{type:"string",description:"Data final (ISO) para filtrar por metadata.date ou created_at"},filter_key:{type:"string",description:"Filtrar por chave de metadata (ex: category)"},filter_value:{type:"string",description:"Filtrar por valor de metadata (ex: alimenta\xE7\xE3o)"},field:{type:"string",description:"Campo num\xE9rico para sum/average"}},required:["collection_name","operation"]}}},{type:"function",function:{name:"manage_reminders",description:"Gerencia lembretes (criar, listar, atualizar, completar)",parameters:{type:"object",properties:{action:{type:"string",enum:["create","list","update","complete"],description:"A\xE7\xE3o"},title:{type:"string",description:"T\xEDtulo do lembrete"},due_at:{type:"string",description:"Data/hora (ISO)"},search_title:{type:"string",description:"Busca para update/complete"}},required:["action"]}}},{type:"function",function:{name:"recall_memory",description:'Busca mem\xF3rias passadas por significado (Busca Vetorial). Use para perguntas vagas ("O que eu falei sobre X?").',parameters:{type:"object",properties:{query:{type:"string",description:"A pergunta ou conceito para buscar na mem\xF3ria."},match_count:{type:"number",description:"N\xFAmero de mem\xF3rias para retornar (default: 5)"}},required:["query"]}}},{type:"function",function:{name:"update_user_settings",description:"Atualiza configura\xE7\xF5es do perfil do usu\xE1rio, como o nome preferido.",parameters:{type:"object",properties:{preferred_name:{type:"string",description:"Novo nome ou apelido como o usu\xE1rio quer ser chamado."},daily_briefing_enabled:{type:"boolean",description:"Ativar ou desativar o Resumo Di\xE1rio."},daily_briefing_time:{type:"string",description:'Hor\xE1rio do resumo (formato HH:MM, ex: "08:00").'},daily_briefing_prompt:{type:"string",description:'Instru\xE7\xF5es personalizadas para o resumo (ex: "Seja engra\xE7ado").'},ai_name:{type:"string",description:'Novo nome para a IA (ex: "Jarvis").'}}}}},{type:"function",function:{name:"send_whatsapp_message",description:'Envia uma mensagem de WhatsApp para um n\xFAmero espec\xEDfico. Use APENAS se o usu\xE1rio pedir explicitamente ("Mande mensagem para X").',parameters:{type:"object",properties:{number:{type:"string",description:"N\xFAmero do destinat\xE1rio (com DDI e DDD, ex: 5511999999999)"},message:{type:"string",description:"Conte\xFAdo da mensagem"}},required:["number","message"]}}},{type:"function",function:{name:"query_messages",description:'Consulta o hist\xF3rico de mensagens do WhatsApp. OBRIGAT\xD3RIO usar se o usu\xE1rio perguntar "o que fulano disse?", "veja a mensagem de X", ou pedir resumo de conversa.',parameters:{type:"object",properties:{sender_number:{type:"string",description:"Filtrar por n\xFAmero do remetente"},sender_name:{type:"string",description:'Filtrar por nome do remetente (ex: "Bianca")'},group_name:{type:"string",description:'Filtrar por nome do grupo (ex: "Fam\xEDlia", "Trabalho")'},limit:{type:"number",description:"N\xFAmero de mensagens (default: 20)"},days_ago:{type:"number",description:"Quantos dias atr\xE1s buscar (default: 7)"}}}}},{type:"function",function:{name:"save_memory",description:"Salva uma informa\xE7\xE3o importante na Mem\xF3ria de Longo Prazo (Vetorial). Use para fatos, prefer\xEAncias ou decis\xF5es que o usu\xE1rio quer que voc\xEA lembre para sempre.",parameters:{type:"object",properties:{content:{type:"string",description:"O conte\xFAdo exato a ser memorizado."},category:{type:"string",description:"Categoria opcional (ex: prefer\xEAncia, fato, decis\xE3o)"}},required:["content"]}}},{type:"function",function:{name:"manage_rules",description:"Gerencia as Regras e Prefer\xEAncias do usu\xE1rio (Brain). Use isso para salvar instru\xE7\xF5es permanentes sobre como o usu\xE1rio gosta que voc\xEA se comporte.",parameters:{type:"object",properties:{action:{type:"string",enum:["create","delete","list"],description:"A\xE7\xE3o a realizar"},key:{type:"string",description:'T\xF3pico da regra (ex: "Tom de voz", "Formata\xE7\xE3o", "Hor\xE1rios")'},value:{type:"string",description:'A regra em si (ex: "Seja sempre formal", "Use listas com emojis")'},id:{type:"string",description:"ID da regra (para delete)"}},required:["action"]}}},{type:"function",function:{name:"manage_users",description:"ADMIN ONLY: Manage users, models and rules. Use this to list users, change their AI model, or delete them.",parameters:{type:"object",properties:{action:{type:"string",enum:["list","update_model","delete","update_rules"]},target_user_id:{type:"string",description:"The ID of the user to modify (required for update/delete)"},model:{type:"string",enum:["gpt-4o","gpt-5.1-preview"],description:"New model to set"},rule_key:{type:"string",description:"Key of the rule to update"},rule_value:{type:"string",description:"Value of the rule to update"}},required:["action"]}}},{type:"function",function:{name:"manage_emails",description:"Gerencia emails do Gmail (ler, enviar, responder, mover, apagar).",parameters:{type:"object",properties:{action:{type:"string",enum:["list","read","send","reply","move_to_trash","archive","mark_as_read"],description:"A\xE7\xE3o a realizar"},provider:{type:"string",enum:["google","microsoft","all"],description:"Provedor (opcional, default: all)"},query:{type:"string",description:'Busca (ex: "from:amazon", "is:unread")'},limit:{type:"number",description:"Limite de emails (default: 5)"},email_id:{type:"string",description:"ID do email (obrigat\xF3rio para read/move/reply)"},to:{type:"string",description:"Destinat\xE1rio (email)"},subject:{type:"string",description:"Assunto"},body:{type:"string",description:"Corpo do email (pode ser HTML ou texto)"}},required:["action"]}}},{type:"function",function:{name:"manage_calendar",description:"Gerencia o CALEND\xC1RIO REAL (Google/Outlook). Use para agendar reuni\xF5es, consultar agenda e ver disponibilidade.",parameters:{type:"object",properties:{action:{type:"string",enum:["list_events","create_event","delete_event"],description:"A\xE7\xE3o a realizar"},start_date:{type:"string",description:"Data inicial (ISO) para listar eventos"},end_date:{type:"string",description:"Data final (ISO) para listar eventos"},title:{type:"string",description:"T\xEDtulo do evento"},description:{type:"string",description:"Descri\xE7\xE3o ou detalhes"},start_time:{type:"string",description:"Data/Hora de in\xEDcio (ISO)"},end_time:{type:"string",description:"Data/Hora de fim (ISO). Se n\xE3o informado, assume 1h de dura\xE7\xE3o."},all_day:{type:"boolean",description:"Se \xE9 evento de dia inteiro"},location:{type:"string",description:"Local do evento"},provider:{type:"string",enum:["google","microsoft"],description:"Provedor espec\xEDfico (opcional)"},event_id:{type:"string",description:"ID do evento para deletar"}},required:["action"]}}}];Y.push({type:"function",function:{name:"global_search",description:"Busca GLOBAL em todas as cole\xE7\xF5es, lembretes e itens. Use quando n\xE3o souber onde algo est\xE1 salvo ou se a busca espec\xEDfica falhar.",parameters:{type:"object",properties:{query:{type:"string",description:'Termo de busca (ex: "senha porta", "compras", "ideia")'},limit:{type:"number",description:"Limite de resultados (default: 10)"}},required:["query"]}}}),Y.push({type:"function",function:{name:"get_unread_conversations",description:'Recupera uma lista de conversas onde a \xFAltima mensagem N\xC3O foi enviada pelo usu\xE1rio (ou seja, est\xE1 "n\xE3o lida" ou aguardando resposta).',parameters:{type:"object",properties:{limit:{type:"number",description:"N\xFAmero m\xE1ximo de conversas para retornar (padr\xE3o: 20)"},offset:{type:"number",description:"Pagina\xE7\xE3o (padr\xE3o: 0)"}}}}});const ie=new Date,x=new Date(ie.getTime()-10800*1e3),se=x.toISOString().replace("Z","-03:00");console.log("\u{1F50D} DEBUG - Server Time (UTC):",ie.toISOString()),console.log("\u{1F50D} DEBUG - Brasilia Time (Calculated):",se);let V=null;const ye=/(?:daqui|em)(?:\s+a)?\s+(\d+|um|uma|dois|duas|trÃªs|quatro|cinco|dez|quinze|vinte|trinta|meia)\s+(minuto|minutos|hora|horas|dia|dias)/i,K=I.match(ye),re={um:1,uma:1,dois:2,duas:2,tr\u00EAs:3,quatro:4,cinco:5,dez:10,quinze:15,vinte:20,trinta:30,meia:.5};if(K){let p=0;const g=K[1].toLowerCase();isNaN(parseInt(g))?re[g]&&(p=re[g]):p=parseInt(g);const O=K[2].toLowerCase(),S=new Date(x.getTime());p>0&&(O.includes("minuto")?S.setMinutes(S.getMinutes()+p):O.includes("hora")?g==="meia"?S.setMinutes(S.getMinutes()+30):S.setHours(S.getHours()+p):O.includes("dia")&&S.setDate(S.getDate()+p),V=S.toISOString().replace("Z","-03:00"),console.log(`\u{1F6E1}\uFE0F SAFETY: Detected relative time "${K[0]}". Calculated override: ${V}`))}let C="You are Ela.ia. Please check database for full prompt.";try{const{data:p,error:g}=await r.from("prompts").select("content").eq("key","system_core").eq("is_active",!0).maybeSingle();p&&p.content?(C=p.content,console.log('\u2705 PROMPT REGISTRY: Loaded "system_core" from DB.')):(console.warn('\u26A0\uFE0F PROMPT REGISTRY: "system_core" not found or inactive. Using fallback.'),g&&console.error("Prompt fetch error:",g))}catch(p){console.error("\u274C PROMPT REGISTRY CRITICAL FAILURE:",p)}let W="gpt-5.1-preview",M=null;try{const{data:p}=await r.from("user_settings").select("custom_system_prompt, ai_model, preferred_name, ai_name").eq("user_id",c).maybeSingle();if(M=p,M?.custom_system_prompt&&console.log("\u26A0\uFE0F IGNORING user_settings.custom_system_prompt in favor of Registry."),typeof C=="string"){const S=M?.preferred_name||"Usu\xE1rio";C=C.replace("{{preferred_name}}",S).replace("{{CURRENT_DATETIME}}",se)}console.log("\u2728 Enforcing GPT 5.1 for all users."),W="gpt-5.1-preview";const g=M?.ai_name;g&&(C+=`

SEU NOME: Seu nome \xE9 "${g}". Se apresente assim se perguntarem.`);const O=M?.preferred_name||"Usu\xE1rio";C+=`

NOME DO USU\xC1RIO: O nome/apelido do usu\xE1rio \xE9 "${O}". Chame-o assim sempre que poss\xEDvel para ser mais pessoal.`,console.log(`\u{1F464} Preferred Name Injected: ${O}`),J||M?.is_admin?(C+=`

STATUS: Voc\xEA est\xE1 falando com o SEU DONO/ADMIN (${O}). Voc\xEA tem permiss\xE3o total para executar comandos, criar tarefas, salvar mem\xF3rias e gerenciar o sistema.`,M?.is_admin&&(C+=`

\u{1F6E1}\uFE0F MODO ADMIN ATIVADO: Voc\xEA tem acesso \xE0 ferramenta \`manage_users\`.
Use-a para listar usu\xE1rios, mudar modelos de IA (gpt-4o, gpt-5.1-preview) ou gerenciar regras.
Se o admin pedir "Liste os usu\xE1rios", use \`manage_users { action: 'list' }\`.
Se o admin pedir "Mude o modelo do Jo\xE3o para GPT-4o", use \`manage_users { action: 'update_model', ... }\`.`)):C+=`

\u26A0\uFE0F ALERTA DE SEGURAN\xC7A - MODO RESTRITO \u26A0\uFE0F
Voc\xEA est\xE1 falando com TERCEIROS (${te}), N\xC3O com o seu dono.
REGRAS ABSOLUTAS:
1. VOC\xCA \xC9 PROIBIDO DE EXECUTAR COMANDOS que alterem o sistema (criar tarefas, mudar configura\xE7\xF5es, deletar mem\xF3rias, gerenciar emails/calend\xE1rio).
2. Se a pessoa pedir para fazer algo ("Cria uma tarefa", "Muda meu nome"), RECUSE educadamente: "Desculpe, apenas meu dono pode fazer isso."
3. Voc\xEA PODE conversar, tirar d\xFAvidas e ser simp\xE1tico, mas aja como uma secret\xE1ria/assistente pessoal que protege a agenda do chefe.
4. Se perguntarem sobre o ${O}, responda com base no que voc\xEA sabe, mas n\xE3o revele dados sens\xEDveis (senhas, endere\xE7os privados).`}catch(p){console.error("Error loading user settings:",p)}console.log("\u{1F916} AI Model:",W),console.log("\u{1F4DD} System Prompt (primeiras 100 chars):",C.substring(0,100)+"..."),console.log("\u2705 Custom settings loaded:",!!M);const{data:he}=await r.from("collections").select("name").eq("user_id",c),ce=he?.map(p=>p.name).join(", ")||"Nenhuma";console.log(`\u{1F4C2} Existing Collections: ${ce}`),C+=`

CONTEXTO DE DADOS ATUAL: 
 - Cole\xE7\xF5es / Pastas Existentes: [${ce}]
 - Use essas pastas se apropriado antes de criar novas.`;const{data:Q}=await r.from("user_preferences").select("key, value").eq("user_id",c);if(Q&&Q.length>0){const p=Q.map(g=>`- [${g.key}]: ${g.value}`).join(`
`);C+=`

REGRAS APRENDIDAS (PREFER\xCANCIAS DO USU\xC1RIO):
${p}
(Siga estas regras acima de tudo).`,console.log(`\u{1F9E0} Injected ${Q.length} user rules.`)}if($==="audio"&&d)if(await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:"Starting audio processing",meta:{mediaUrlLength:d.length,isDataUri:d.startsWith("data:")}}),I&&!I.includes("[\xC1udio")&&!I.includes("processando")&&I.length>3)console.log("\u2705 Using Evolution API transcription (PT-BR):",I),await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:"Using Evolution transcription",meta:{text:I}});else{console.log("\u26A0\uFE0F No useful text from Evolution - attempting Whisper fallback...");try{let g;if(d.startsWith("data:")){console.log("Processing Data URI...");const h=d.split(",")[1],e=d.split(";")[0].split(":")[1],s=atob(h),i=new Uint8Array(s.length);for(let t=0;t<s.length;t++)i[t]=s.charCodeAt(t);g=new Blob([i],{type:e}),console.log(`\u2705 Converted Base64 to Blob: ${g.size} bytes, type: ${e}`),await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:"Converted Base64 to Blob",meta:{size:g.size,type:e}})}else{console.log("\u{1F4E5} Downloading audio from URL:",d);const h=await fetch(d);if(!h.ok)throw console.error(`\u274C Failed to fetch audio: ${h.status} `),await r.from("debug_logs").insert({function_name:"process-message",level:"error",message:"Failed to fetch audio URL",meta:{status:h.status,url:d}}),new Error(`Failed to fetch audio: ${h.status}`);g=await h.blob(),console.log(`\u2705 Audio downloaded: ${g.size} bytes`)}const O=new FormData;O.append("file",g,"audio.ogg"),O.append("model","whisper-1"),O.append("language","pt"),O.append("prompt","Esta \xE9 uma mensagem de \xE1udio em portugu\xEAs brasileiro. Transcrever em portugu\xEAs do Brasil."),O.append("temperature","0"),console.log("\u{1F680} Sending to Whisper API...");const k=await(await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${F}`},body:O})).json();k.text?(console.log("\u2705 Whisper Fallback SUCCESS:",k.text),I=k.text,await r.from("debug_logs").insert({function_name:"process-message",level:"success",message:"Whisper Transcription Success",meta:{text:k.text}})):(console.error("\u274C Whisper Error:",k),await r.from("debug_logs").insert({function_name:"process-message",level:"error",message:"Whisper API Error",meta:k}),k.error?.message?.includes("Invalid file format")?I="O \xE1udio est\xE1 criptografado ou em formato inv\xE1lido.":I="N\xE3o foi poss\xEDvel transcrever o \xE1udio.")}catch(g){console.error("\u274C Error processing audio:",g),await r.from("debug_logs").insert({function_name:"process-message",level:"error",message:"Audio processing exception",meta:{error:g.message,stack:g.stack}}),I="Erro ao processar \xE1udio. Por favor, envie novamente."}}if(console.log("\u{1F4DD} FINAL TEXT SENT TO AI:",I),m&&I&&$==="audio"&&(console.log(`\u{1F4BE} Updating transcription for message ${m}...`),await r.from("messages").update({content:I}).eq("id",m)),I&&!J){const{data:p}=await r.from("monitors").select("*").eq("user_id",c).eq("is_active",!0);if(p&&p.length>0){const g=p.filter(O=>{const S=I.toLowerCase().includes(O.keyword.toLowerCase()),k=!O.chat_name||P&&P.toLowerCase().includes(O.chat_name.toLowerCase());return S&&k});g.length>0&&(console.log(`\u{1F514} MONITOR TRIGGERED: ${g.length} matches found.`),C+=`

\u{1F6A8} ALERTA DE MONITORAMENTO: A mensagem acima contem "${g[0].keyword}" que voc\xEA estava monitorando!
                    A\xE7\xE3o Obrigat\xF3ria: Avise o usu\xE1rio IMEDIATAMENTE.
                    Mensagem: "${I}"
                    Contexto: ${P||"Chat Privado"}
                    Regra: ${g[0].frequency} (Se for 'once', avise que vai parar de monitorar. Se for 'ask', pergunte se deve parar).`)}}const{data:le}=await r.from("messages").select("role, content").eq("user_id",c).order("created_at",{ascending:!1}).limit(10),de=(le?le.reverse():[]).filter(p=>p.content!==I);console.log(`\u{1F9E0} Context loaded: ${de.length} previous messages.`);const z=[{role:"system",content:C||DEFAULT_SYSTEM_PROMPT},...de.map(p=>({role:p.role,content:p.content||(p.media_url?"[Media Message]":"")}))];d&&$!=="audio"&&z.push({role:"system",content:`[User attached a file / media.URL: ${d} (Type: ${$})]`}),d&&$==="image"?z.push({role:"user",content:[{type:"text",text:I},{type:"image_url",image_url:{url:d}}]}):z.push({role:"user",content:I});let me=0;const we=5;let X="";for(;me<we;){me++;let p=W;console.log(`\u{1F916} Final Model for Inference: ${p} (Requested: ${W})`);let g=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},body:JSON.stringify({model:p,messages:z,tools:Y,tool_choice:"auto",temperature:.7})});!g.ok&&p==="gpt-5.1-preview"&&(console.warn("\u26A0\uFE0F GPT 5.1 failed (likely not available). Falling back to GPT-4o."),await r.from("debug_logs").insert({function_name:"process-message",level:"warning",message:"GPT 5.1 failed, falling back to GPT-4o",meta:{status:g.status}}),p="gpt-4o",g=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},body:JSON.stringify({model:p,messages:z,tools:Y,tool_choice:"auto",temperature:.7})}));const O=await g.json();if(!O.choices?.[0])throw console.error("GPT Error:",O),new Error("Erro na comunica\xE7\xE3o com a AI");const S=O.choices[0].message;if(z.push(S),S.content&&console.log("\u{1F4AD} THOUGHT:",S.content),!S.tool_calls||S.tool_calls.length===0){X=S.content;break}for(const k of S.tool_calls){const h=k.function.name,e=JSON.parse(k.function.arguments);console.log(`\u{1F527} TOOL CALL: ${h}`),console.log("\u{1F527} ARGS:",JSON.stringify(e));let s="";try{if(!J)throw console.warn(`\u{1F6D1} BLOCKED TOOL EXECUTION: ${h} called by non-owner (${te})`),new Error(`\u26D4 A\xE7\xE3o Bloqueada: Apenas o dono (${M?.preferred_name||"Vitor"}) pode executar comandos.`);if(await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:`Executing tool: ${h}`,meta:{args:e}}),h==="manage_collections")s=await ve(r,c,e);else if(h==="manage_financials"){if(e.action==="add")if(!e.amount)s="Erro: 'amount' \xE9 obrigat\xF3rio para finan\xE7as. Pergunte ao usu\xE1rio o valor.";else{let i=null;const{data:t}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(t)i=t.id;else{const{data:a}=await r.from("collections").insert({user_id:c,name:e.collection_name,icon:"\u{1F4B0}"}).select().single();i=a.id}const{error:o}=await r.from("collection_items").insert({collection_id:i,user_id:c,type:"expense",content:e.description||"Gasto sem descri\xE7\xE3o",metadata:{amount:e.amount,category:e.category||"Geral",section:e.category||"Geral",date:e.date||new Date().toISOString()}});o?s=`Erro ao salvar gasto: ${o.message}`:s=`Gasto de ${e.amount} salvo em "${e.collection_name}".`}else if(e.action==="list")s="Use query_data para listar finan\xE7as com filtros.";else if(e.action==="delete"){const{data:i}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!i)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",i.id).eq("type","expense");e.description&&(t=t.ilike("content",`%${e.description}%`)),e.amount&&(t=t.eq("metadata->>amount",e.amount));const{data:o}=await t.limit(5);!o||o.length===0?s="Erro: Item financeiro n\xE3o encontrado para exclus\xE3o.":o.length>1?s=`M\xFAltiplos itens encontrados. Qual apagar?
${o.map(n=>`- ${n.content} (R$ ${n.metadata.amount})`).join(`
`)}`:(await r.from("collection_items").delete().eq("id",o[0].id),s="Gasto removido com sucesso.")}}else if(e.action==="update"){const{data:i}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!i)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",i.id).eq("type","expense");e.description&&(t=t.ilike("content",`%${e.description}%`)),e.search_amount&&(t=t.eq("metadata->>amount",e.search_amount));const{data:o}=await t.limit(5);if(!o||o.length===0)s="Erro: Item financeiro n\xE3o encontrado para atualiza\xE7\xE3o.";else if(o.length>1)s=`M\xFAltiplos itens encontrados. Qual atualizar?
${o.map(n=>`- ${n.content} (R$ ${n.metadata.amount})`).join(`
`)}`;else{const a=o[0],n={...a.metadata};e.amount&&(n.amount=e.amount),e.category&&(n.category=e.category,n.section=e.category),e.date&&(n.date=e.date),await r.from("collection_items").update({content:e.new_description||a.content,metadata:n}).eq("id",a.id),s="Gasto atualizado com sucesso."}}}}else if(h==="manage_credentials"){if(e.action==="add"){let i=null;const{data:t}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(t)i=t.id;else{const{data:a}=await r.from("collections").insert({user_id:c,name:e.collection_name,icon:"\u{1F512}"}).select().single();i=a.id}const{error:o}=await r.from("collection_items").insert({collection_id:i,user_id:c,type:"credential",content:e.service_name||"Credencial",metadata:{username:e.username,password:e.password,url:e.url,notes:e.notes,type:"credential"}});o?s=`Erro ao salvar credencial: ${o.message}`:s=`Credencial para "${e.service_name}" salva com seguran\xE7a.`}else if(e.action==="delete"){const{data:i}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!i)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",i.id).eq("type","credential");e.service_name&&(t=t.ilike("content",`%${e.service_name}%`)),e.username&&(t=t.eq("metadata->>username",e.username));const{data:o}=await t.limit(5);!o||o.length===0?s="Erro: Credencial n\xE3o encontrada para exclus\xE3o.":o.length>1?s=`M\xFAltiplas credenciais encontradas. Qual apagar?
${o.map(n=>`- ${n.content} (User: ${n.metadata.username})`).join(`
`)}`:(await r.from("collection_items").delete().eq("id",o[0].id),s="Credencial removida com sucesso.")}}else if(e.action==="update"){const{data:i}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!i)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",i.id).eq("type","credential");e.service_name&&(t=t.ilike("content",`%${e.service_name}%`)),e.username&&(t=t.eq("metadata->>username",e.username));const{data:o}=await t.limit(5);if(!o||o.length===0)s="Erro: Credencial n\xE3o encontrada para atualiza\xE7\xE3o.";else if(o.length>1)s=`M\xFAltiplas credenciais encontradas. Qual atualizar?
${o.map(n=>`- ${n.content} (User: ${n.metadata.username})`).join(`
`)}`;else{const a=o[0],n={...a.metadata};e.new_username&&(n.username=e.new_username),e.new_password&&(n.password=e.new_password),e.url&&(n.url=e.url),e.notes&&(n.notes=e.notes),await r.from("collection_items").update({content:e.new_service_name||a.content,metadata:n}).eq("id",a.id),s="Credencial atualizada com sucesso."}}}}else if(h==="manage_inventory"){if(e.action==="add"){let i=null;const{data:t}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(t)i=t.id;else{const{data:o}=await r.from("collections").insert({user_id:c,name:e.collection_name,icon:"\u{1F4CB}"}).select().single();i=o.id}if(e.items&&e.items.length>0){const o=e.items.map(n=>({collection_id:i,user_id:c,type:"list_item",content:n.content,metadata:{quantity:n.quantity,category:n.category,section:n.category||"Geral",checked:n.checked||!1,notes:n.notes,type:"list_item"}})),{error:a}=await r.from("collection_items").insert(o);a?s=`Erro ao salvar lista: ${a.message}`:s=`${e.items.length} itens adicionados \xE0 lista "${e.collection_name}".`}else s="Nenhum item fornecido para a lista."}else if(e.action==="delete"){const{data:i}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!i)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",i.id).eq("type","list_item");e.content&&(t=t.ilike("content",`%${e.content}%`));const{data:o}=await t.limit(5);!o||o.length===0?s="Erro: Item da lista n\xE3o encontrado para exclus\xE3o.":o.length>1?s=`M\xFAltiplos itens parecidos. Qual apagar?
${o.map(n=>`- ${n.content}`).join(`
`)}`:(await r.from("collection_items").delete().eq("id",o[0].id),s="Item removido da lista com sucesso.")}}else if(e.action==="update"){const{data:i}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!i)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",i.id).eq("type","list_item");e.content&&(t=t.ilike("content",`%${e.content}%`));const{data:o}=await t.limit(5);if(!o||o.length===0)s="Erro: Item da lista n\xE3o encontrado para atualiza\xE7\xE3o.";else if(o.length>1)s=`M\xFAltiplos itens parecidos. Qual atualizar?
${o.map(n=>`- ${n.content}`).join(`
`)}`;else{const a=o[0],n={...a.metadata};e.quantity&&(n.quantity=e.quantity),e.category&&(n.category=e.category),e.checked!==void 0&&(n.checked=e.checked),e.notes&&(n.notes=e.notes),await r.from("collection_items").update({content:e.new_content||a.content,metadata:n}).eq("id",a.id),s="Item da lista atualizado com sucesso."}}}}else if(h==="manage_items"){if(e.metadata){if(e.metadata.password||e.metadata.username)throw new Error("FORBIDDEN: You are trying to save CREDENTIALS using the generic 'manage_items' tool. You MUST use 'manage_credentials' for security.");if(e.metadata.amount)throw new Error("FORBIDDEN: You are trying to save FINANCIAL data using 'manage_items'. You MUST use 'manage_financials' to ensure correct calculations.")}if(e.items&&Array.isArray(e.items))for(const t of e.items){if(t.metadata?.password||t.metadata?.username)throw new Error("FORBIDDEN: You are trying to save CREDENTIALS using 'manage_items'. Use 'manage_credentials'.");if(t.metadata?.amount)throw new Error("FORBIDDEN: You are trying to save FINANCIAL data using 'manage_items'. Use 'manage_financials'.")}const{data:i}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(i){if(e.action==="list"){const{data:t}=await r.from("collection_items").select("*").eq("collection_id",i.id).order("created_at",{ascending:!1}).limit(20);s=`Itens na pasta "${e.collection_name}":
${t?.map(o=>`- ${o.content} (${JSON.stringify(o.metadata)})`).join(`
`)||"Vazia"}`}else if(e.action==="add")if(e.items&&Array.isArray(e.items)&&e.items.length>0){console.log(`\u{1F680} BATCH ADD: ${e.items.length} items to ${e.collection_name}`);const t=e.items.map(a=>({collection_id:i.id,user_id:c,type:a.metadata?.type||"text",content:a.content||"Item sem nome",media_url:null,metadata:a.metadata?{...a.metadata,amount:a.metadata.amount?Number(a.metadata.amount):void 0}:null})),{error:o}=await r.from("collection_items").insert(t);o?(console.error("\u274C Error in batch insert:",o),s=`Erro ao adicionar itens em lote: ${o.message}`):s=`${e.items.length} itens adicionados com sucesso na pasta "${e.collection_name}".`}else{const{error:t}=await r.from("collection_items").insert({collection_id:i.id,user_id:c,type:e.type||"text",content:e.content||null,media_url:e.media_url||d||null,metadata:e.metadata?{...e.metadata,amount:e.metadata.amount?Number(e.metadata.amount):void 0}:null});t?(console.error("\u274C Error inserting item into EXISTING collection:",t),s=`Erro ao salvar item: ${t.message} `):(console.log(`\u2705 Item inserted into EXISTING collection ${i.id} `),s=`Item adicionado na pasta "${e.collection_name}".`)}else if(e.action==="update"||e.action==="delete"){let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",i.id);const o=e.search_content||e.content;o&&(t=t.ilike("content",`%${o}%`)),e.search_metadata_key&&e.search_metadata_value&&(t=t.eq(`metadata ->> ${e.search_metadata_key} `,e.search_metadata_value));const{data:a}=await t.limit(5);let n=null;if(!a||a.length===0)s=`Erro: N\xE3o encontrei nenhum item correspondente na pasta "${e.collection_name}".`;else if(a.length>1){const l=a.map(w=>`- ${w.content} (ID: ${w.id})`).join(`
`);s=`Encontrei m\xFAltiplos itens parecidos. Qual deles voc\xEA quer ${e.action==="delete"?"apagar":"alterar"}?
${l}

Por favor, seja mais espec\xEDfico.`}else if(n=a[0],e.action==="delete")await r.from("collection_items").delete().eq("id",n.id),s=`Item apagado da pasta "${e.collection_name}".`;else{let l=e.content||n.content;e.should_append&&e.content&&(l=`${n.content}
${e.content}`),await r.from("collection_items").update({content:l,metadata:e.metadata?{...n.metadata,...e.metadata,amount:e.metadata.amount?Number(e.metadata.amount):n.metadata?.amount||void 0}:n.metadata}).eq("id",n.id),s=`Item atualizado na pasta "${e.collection_name}".`}}}else{const{data:t,error:o}=await r.from("collections").insert({user_id:c,name:e.collection_name,icon:"\u{1F4C1}"}).select().single();if(o||!t)s=`Erro: N\xE3o foi poss\xEDvel criar a pasta "${e.collection_name}".`;else if(e.items&&Array.isArray(e.items)&&e.items.length>0){const a=e.items.map(l=>({collection_id:t.id,user_id:c,type:l.metadata?.type||"text",content:l.content||"Item sem nome",media_url:null,metadata:l.metadata?{...l.metadata,amount:l.metadata.amount?Number(l.metadata.amount):void 0}:null})),{error:n}=await r.from("collection_items").insert(a);n?s=`Pasta criada, mas erro ao adicionar itens: ${n.message}`:s=`Pasta "${e.collection_name}" criada e ${e.items.length} itens adicionados.`}else{const{error:a}=await r.from("collection_items").insert({collection_id:t.id,user_id:c,type:e.type||"text",content:e.content||null,media_url:e.media_url||d||null,metadata:e.metadata?{...e.metadata,amount:e.metadata.amount?Number(e.metadata.amount):void 0}:null});a?(console.error("\u274C Error inserting item into NEW collection:",a),s=`Erro ao salvar item na nova pasta: ${a.message} `):(console.log(`\u2705 Item inserted into NEW collection ${t.id} `),s=`Pasta "${e.collection_name}" criada automaticamente e item adicionado com sucesso.`)}}}else if(h==="manage_monitors"){if(e.action==="create")if(!e.keyword)s="Erro: 'keyword' \xE9 obrigat\xF3rio para criar um monitor.";else{const{error:i}=await r.from("monitors").insert({user_id:c,keyword:e.keyword,chat_name:e.chat_name||null,frequency:e.frequency||"ask"});i?s=`Erro ao criar monitor: ${i.message}`:s=`Monitor criado! Vou te avisar se encontrar "${e.keyword}" ${e.chat_name?`em "${e.chat_name}"`:"em qualquer conversa"}.`}else if(e.action==="list"){const{data:i}=await r.from("monitors").select("*").eq("user_id",c).eq("is_active",!0);!i||i.length===0?s="Nenhum monitor ativo no momento.":s=`Monitores Ativos:
`+i.map(t=>`- "${t.keyword}" (${t.chat_name||"Todos"}) [${t.frequency}]`).join(`
`)}else if(e.action==="delete"){const{error:i}=await r.from("monitors").delete().eq("user_id",c).ilike("keyword",`%${e.keyword}%`);i?s=`Erro ao apagar monitor: ${i.message}`:s="Monitor removido."}}else if(h==="manage_rules"){if(console.log("rules manager called",e),e.action==="create")if(!e.key||!e.value)s="Erro: 'key' e 'value' s\xE3o obrigat\xF3rios para criar uma regra.";else{const{error:i}=await r.from("user_preferences").insert({user_id:c,key:e.key,value:e.value});i?(console.error("Error creating rule:",i),s=`Erro ao criar regra: ${i.message}`):s=`Regra criada: [${e.key}] ${e.value}`}else if(e.action==="delete")if(!e.id&&!e.key)s="Erro: Forne\xE7a o ID da regra ou o 'key' para deletar.";else{let i=r.from("user_preferences").delete().eq("user_id",c);e.id?i=i.eq("id",e.id):e.key&&(i=i.eq("key",e.key));const{error:t}=await i;t?(console.error("Error deleting rule:",t),s=`Erro ao deletar regra: ${t.message}`):s="Regra(s) removida(s) com sucesso."}else if(e.action==="list"){const{data:i}=await r.from("user_preferences").select("*").eq("user_id",c);i&&i.length>0?s=`Regras Atuais:
`+i.map(t=>`ID: ${t.id} | [${t.key}]: ${t.value}`).join(`
`):s="Nenhuma regra definida."}}else if(h==="get_unread_conversations"){const i=e.limit||20,t=e.offset||0,{data:o,error:a}=await r.rpc("get_unread_conversations",{p_user_id:c,p_limit:i,p_offset:t});a?(console.error("Error fetching unread conversations:",a),s=`Erro ao buscar conversas n\xE3o lidas: ${a.message}`):!o||o.length===0?s="Nenhuma conversa n\xE3o lida encontrada.":s=`Conversas n\xE3o lidas:
`+o.map(n=>{const l=n.group_name||n.sender_name||n.sender_number,w=n.is_group?"[Grupo]":"[Privado]",L=new Date(n.last_message_at).toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"});return`- ${w} ${l}: "${n.last_message_content?.substring(0,50)}..." (${L})`}).join(`
`)}else if(h==="manage_emails"){console.log("\u{1F4E7} Managing Emails:",e);const i=e.provider||"all",t=i==="all"?["google","microsoft"]:[i],{data:o}=await r.from("user_integrations").select("*").eq("user_id",c).in("provider",t);if(!o||o.length===0)s="Nenhuma conta de email conectada para o provedor solicitado. Por favor, conecte suas contas nas configura\xE7\xF5es.";else{const a=[];for(const n of o)try{let l=n.access_token;const w=new Date(n.expires_at),L=new Date,U=n.provider==="google",G=n.provider==="microsoft";if(w.getTime()-L.getTime()<300*1e3){console.log(`\u{1F504} Refreshing ${n.provider} Token...`);let f="",u={};U?(f="https://oauth2.googleapis.com/token",u={client_id:Deno.env.get("GOOGLE_CLIENT_ID"),client_secret:Deno.env.get("GOOGLE_CLIENT_SECRET"),refresh_token:n.refresh_token,grant_type:"refresh_token"}):G&&(f="https://login.microsoftonline.com/common/oauth2/v2.0/token",u={client_id:Deno.env.get("MICROSOFT_CLIENT_ID"),client_secret:Deno.env.get("MICROSOFT_CLIENT_SECRET"),refresh_token:n.refresh_token,grant_type:"refresh_token"});const E=await(await fetch(f,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(u)})).json();if(E.error)throw new Error(E.error_description||E.error);l=E.access_token;const y=new Date(Date.now()+E.expires_in*1e3).toISOString();await r.from("user_integrations").update({access_token:l,expires_at:y,updated_at:new Date().toISOString()}).eq("id",n.id)}const N={Authorization:`Bearer ${l}`,"Content-Type":"application/json"};if(U){const f="https://gmail.googleapis.com/gmail/v1/users/me";if(e.action==="list"){const u=e.query||"is:inbox",E=await(await fetch(`${f}/messages?q=${encodeURIComponent(u)}&maxResults=${e.limit||5}`,{headers:N})).json();if(E.messages)for(const y of E.messages){const R=await(await fetch(`${f}/messages/${y.id}?format=metadata&metadataHeaders=From&metadataHeaders=Subject&metadataHeaders=Date`,{headers:N})).json(),ae=R.payload.headers.find(H=>H.name==="Subject")?.value||"(Sem Assunto)",j=R.payload.headers.find(H=>H.name==="From")?.value||"Desconhecido",Z=R.payload.headers.find(H=>H.name==="Date")?.value||"";a.push(`[GMAIL] ID: ${y.id} | ${Z} | De: ${j} | ${ae}`)}}else if(e.action==="read"){const u=await fetch(`${f}/messages/${e.email_id}?format=full`,{headers:N});if(u.ok){const _=await u.json();let y=_.snippet;const A=j=>{try{return atob(j.replace(/-/g,"+").replace(/_/g,"/"))}catch{return"(Erro decode)"}};if(_.payload.body?.data)y=A(_.payload.body.data);else if(_.payload.parts){const j=_.payload.parts.find(Z=>Z.mimeType==="text/plain");j?.body?.data&&(y=A(j.body.data))}const R=_.payload.headers.find(j=>j.name==="Subject")?.value,ae=_.payload.headers.find(j=>j.name==="From")?.value;a.push(`[GMAIL] De: ${ae}
Assunto: ${R}
Corpo: ${y}`)}}else if(e.action==="send"||e.action==="reply"){const _=[`To: ${e.to}`,`Subject: ${e.subject}`,'Content-Type: text/plain; charset="UTF-8"',"MIME-Version: 1.0","",e.body].join(`
`),E=btoa(unescape(encodeURIComponent(_))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),y=await fetch(`${f}/messages/send`,{method:"POST",headers:N,body:JSON.stringify({raw:E})});y.ok?a.push("[GMAIL] Enviado com sucesso."):a.push(`[GMAIL] Erro ao enviar: ${(await y.json()).error.message}`)}else e.action==="move_to_trash"&&(await fetch(`${f}/messages/${e.email_id}/trash`,{method:"POST",headers:N}),a.push("[GMAIL] Movido para lixeira."))}else if(G){const f="https://graph.microsoft.com/v1.0/me";if(e.action==="list"){const _=await(await fetch(`${f}/messages?$top=${e.limit||5}&$select=id,subject,from,receivedDateTime,bodyPreview&$orderby=receivedDateTime desc`,{headers:N})).json();if(_.value)for(const E of _.value)a.push(`[OUTLOOK] ID: ${E.id} | ${E.receivedDateTime} | De: ${E.from.emailAddress.name} <${E.from.emailAddress.address}> | ${E.subject}`)}else if(e.action==="read"){const u=await fetch(`${f}/messages/${e.email_id}?$select=subject,from,toRecipients,receivedDateTime,body`,{headers:N});if(u.ok){const _=await u.json(),E=_.body.content.replace(/<[^>]*>?/gm,"");a.push(`[OUTLOOK] De: ${_.from.emailAddress.name}
Assunto: ${_.subject}
Corpo: ${E}`)}}else if(e.action==="send"||e.action==="reply"){const u={message:{subject:e.subject,body:{contentType:"Text",content:e.body},toRecipients:[{emailAddress:{address:e.to}}]},saveToSentItems:"true"},_=await fetch(`${f}/sendMail`,{method:"POST",headers:N,body:JSON.stringify(u)});_.ok?a.push("[OUTLOOK] Enviado com sucesso."):a.push(`[OUTLOOK] Erro ao enviar: ${await _.text()}`)}else if(e.action==="move_to_trash"){const u=await fetch(`${f}/messages/${e.email_id}`,{method:"DELETE",headers:N});u.ok?a.push("[OUTLOOK] Movido para lixeira."):a.push(`[OUTLOOK] Erro ao apagar: ${await u.text()}`)}}}catch(l){console.error(`Error processing ${n.provider}:`,l),a.push(`[${n.provider.toUpperCase()}] Erro: ${l.message}`)}s=a.length>0?a.join(`

`):"Nenhum resultado encontrado."}}else if(h==="manage_users"){if(!M?.is_admin)throw new Error("\u26D4 ACESSO NEGADO: Apenas administradores podem usar esta ferramenta.");if(console.log("\u{1F6E1}\uFE0F ADMIN ACTION:",e),e.action==="list"){const{data:i,error:t}=await r.from("user_settings").select("user_id, preferred_name, ai_model, is_admin");if(t)throw t;s=`\u{1F465} Lista de Usu\xE1rios:
${i.map(a=>`- ${a.preferred_name||"Sem Nome"} (ID: ${a.user_id}) [Model: ${a.ai_model}] ${a.is_admin?"\u{1F6E1}\uFE0F ADMIN":""}`).join(`
`)}`}else if(e.action==="update_model"){if(!e.target_user_id||!e.model)throw new Error("target_user_id e model s\xE3o obrigat\xF3rios.");const{error:i}=await r.from("user_settings").update({ai_model:e.model}).eq("user_id",e.target_user_id);if(i)throw i;s=`\u2705 Modelo do usu\xE1rio ${e.target_user_id} atualizado para ${e.model}.`}else if(e.action==="delete"){if(!e.target_user_id)throw new Error("target_user_id \xE9 obrigat\xF3rio.");const{error:i}=await r.from("user_settings").delete().eq("user_id",e.target_user_id);if(i)throw i;s=`\u26A0\uFE0F Configura\xE7\xF5es do usu\xE1rio ${e.target_user_id} apagadas. (A conta Auth ainda existe).`}}else if(h==="manage_calendar"){console.log("\u{1F4C5} Managing Calendar:",e);const i=e.provider||"all",t=i==="all"?["google","microsoft"]:[i],{data:o}=await r.from("user_integrations").select("*").eq("user_id",c).in("provider",t);if(!o||o.length===0)s="Nenhuma conta de calend\xE1rio conectada. Por favor, conecte Google ou Outlook nas configura\xE7\xF5es.";else{const a=[];for(const n of o)try{let l=n.access_token;const w=new Date(n.expires_at),L=new Date,U=n.provider==="google",G=n.provider==="microsoft";if(w.getTime()-L.getTime()<300*1e3){console.log(`\u{1F504} Refreshing ${n.provider} Token...`);let f="",u={};U?(f="https://oauth2.googleapis.com/token",u={client_id:Deno.env.get("GOOGLE_CLIENT_ID"),client_secret:Deno.env.get("GOOGLE_CLIENT_SECRET"),refresh_token:n.refresh_token,grant_type:"refresh_token"}):G&&(f="https://login.microsoftonline.com/common/oauth2/v2.0/token",u={client_id:Deno.env.get("MICROSOFT_CLIENT_ID"),client_secret:Deno.env.get("MICROSOFT_CLIENT_SECRET"),refresh_token:n.refresh_token,grant_type:"refresh_token"});const E=await(await fetch(f,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(u)})).json();if(E.error)throw new Error(E.error_description||E.error);l=E.access_token;const y=new Date(Date.now()+E.expires_in*1e3).toISOString();await r.from("user_integrations").update({access_token:l,expires_at:y,updated_at:new Date().toISOString()}).eq("id",n.id)}const N={Authorization:`Bearer ${l}`,"Content-Type":"application/json"};if(e.action==="list_events"){const f=e.start_date||new Date().toISOString(),u=e.end_date||new Date(Date.now()+10080*60*1e3).toISOString();if(U){const _=`https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${f}&timeMax=${u}&singleEvents=true&orderBy=startTime`,y=await(await fetch(_,{headers:N})).json();y.items&&a.push(...y.items.map(A=>`[GOOGLE] ${A.start.dateTime?new Date(A.start.dateTime).toLocaleString("pt-BR"):`${A.start.date} (Dia todo)`} - ${A.summary} (ID: ${A.id})`))}else if(G){const _=`https://graph.microsoft.com/v1.0/me/calendarView?startDateTime=${f}&endDateTime=${u}&$top=20&$select=id,subject,start,end,isAllDay`,y=await(await fetch(_,{headers:N})).json();y.value&&a.push(...y.value.map(A=>`[OUTLOOK] ${A.isAllDay?`${A.start.dateTime.split("T")[0]} (Dia todo)`:new Date(A.start.dateTime).toLocaleString("pt-BR")} - ${A.subject} (ID: ${A.id})`))}}else if(e.action==="create_event"){const f=e.start_time;let u=e.end_time;if(!u&&f){const _=new Date(f);_.setHours(_.getHours()+1),u=_.toISOString()}if(U){const _={summary:e.title,description:e.description,start:e.all_day?{date:f.split("T")[0]}:{dateTime:f},end:e.all_day?{date:u.split("T")[0]}:{dateTime:u},location:e.location},y=await(await fetch("https://www.googleapis.com/calendar/v3/calendars/primary/events",{method:"POST",headers:N,body:JSON.stringify(_)})).json();y.id?a.push(`[GOOGLE] Evento criado: "${e.title}" em ${new Date(f).toLocaleString("pt-BR")}`):a.push(`[GOOGLE] Erro ao criar: ${JSON.stringify(y)}`)}else if(G){const _={subject:e.title,body:{contentType:"Text",content:e.description||""},start:{dateTime:f,timeZone:"America/Sao_Paulo"},end:{dateTime:u,timeZone:"America/Sao_Paulo"},location:{displayName:e.location},isAllDay:e.all_day},y=await(await fetch("https://graph.microsoft.com/v1.0/me/events",{method:"POST",headers:N,body:JSON.stringify(_)})).json();y.id?a.push(`[OUTLOOK] Evento criado: "${e.title}" em ${new Date(f).toLocaleString("pt-BR")}`):a.push(`[OUTLOOK] Erro ao criar: ${JSON.stringify(y)}`)}}else if(e.ac