import "jsr:@supabase/functions-js/edge-runtime.d.ts";
declare const Deno: any;
import { createClient } from 'jsr:@supabase/supabase-js@2';

interface ProcessMessageRequest {
    content?: string;
    mediaUrl?: string;
    mediaType?: 'image' | 'audio' | 'document';
    userId: string;
    messageId?: string;
    is_owner?: boolean;
    sender_name?: string;
    sender_number?: string;
    is_group?: boolean;
    group_name?: string;
}

function calculateDueAt(args: any, brasiliaTime: Date, overrideDueAt: string | null): string | null {
    let finalDueAt = args.due_at || null;

    if (args.time_config) {
        const { mode } = args.time_config;
        const targetDate = new Date(brasiliaTime.getTime());
        console.log(`üß† TIME CONFIG RECEIVED: Mode = ${mode} `, args.time_config);

        if (mode === 'relative') {
            const { relative_amount, relative_unit } = args.time_config;
            if (relative_amount && relative_unit) {
                if (relative_unit === 'minutes') targetDate.setMinutes(targetDate.getMinutes() + relative_amount);
                else if (relative_unit === 'hours') targetDate.setHours(targetDate.getHours() + relative_amount);
                else if (relative_unit === 'days') targetDate.setDate(targetDate.getDate() + relative_amount);

                finalDueAt = targetDate.toISOString().replace('Z', '-03:00');
            }
        } else if (mode === 'absolute') {
            const { target_day, target_month, target_year, target_hour, target_minute } = args.time_config;

            // Se ano n√£o informado, usa atual
            if (target_year) targetDate.setFullYear(target_year);

            // Se m√™s informado (1-12), ajusta (0-11)
            if (target_month) targetDate.setMonth(target_month - 1);

            // Se dia informado
            if (target_day) targetDate.setDate(target_day);

            // Se hora informada
            if (target_hour !== undefined) targetDate.setHours(target_hour);
            else targetDate.setHours(9); // Default para "manh√£" se n√£o especificado

            // Se minuto informado
            if (target_minute !== undefined) targetDate.setMinutes(target_minute);
            else targetDate.setMinutes(0);

            finalDueAt = targetDate.toISOString().replace('Z', '-03:00');
        }
    }
    // FALLBACKS (Para compatibilidade ou seguran√ßa)
    else if (args.relative_time && args.relative_time.amount) {
        // L√≥gica antiga (H√≠brido 1.0)
        const { amount, unit } = args.relative_time;
        const targetDate = new Date(brasiliaTime.getTime());
        if (unit === 'minutes') targetDate.setMinutes(targetDate.getMinutes() + amount);
        else if (unit === 'hours') targetDate.setHours(targetDate.getHours() + amount);
        else if (unit === 'days') targetDate.setDate(targetDate.getDate() + amount);
        finalDueAt = targetDate.toISOString().replace('Z', '-03:00');
    }
    else if (overrideDueAt) {
        finalDueAt = overrideDueAt;
    }

    return finalDueAt;
}

Deno.serve(async (req: Request) => {
    if (req.method === 'OPTIONS') {
        return new Response(null, {
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
            },
        });
    }

    try {
        const { content, mediaUrl, mediaType, userId, messageId, is_owner, sender_name, sender_number, is_group, group_name }: ProcessMessageRequest = await req.json();
        console.log(`üöÄ Process Message HIT: ${content?.substring(0, 50)}...`);

        const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
        const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
        const supabase = createClient(supabaseUrl, supabaseKey);

        const openaiKey = Deno.env.get('OPENAI_API_KEY');
        if (!openaiKey) {
            return new Response(
                JSON.stringify({ success: false, error: 'OpenAI API key not configured' }),
                { status: 500, headers: { 'Content-Type': 'application/json' } }
            );
        }

        let processedText = content || '';

        // --- üß† AUTHORITY & CONTEXT INJECTION ---
        const isOwner = is_owner !== false; // Default to true if undefined (backward compatibility)
        const senderName = sender_name || 'Desconhecido';

        // --- CONTEXT INJECTION ---
        const contextInfo = `
CONTEXTO ATUAL:
- Data/Hora: ${new Date().toISOString()}
- Usu√°rio: ${userId}
- Canal: WhatsApp ${is_group ? '(GRUPO)' : '(PRIVADO)'}
- Remetente da Mensagem: ${sender_name || 'Desconhecido'} (${sender_number || '?'})
- Voc√™ √© o Dono? ${isOwner ? 'SIM' : 'N√ÉO'}
`;

        console.log(`üë§ Sender: ${senderName} (${sender_number || '?'}) | Is Owner: ${isOwner}`);

        // --- ECONOMY MODE: SKIP NON-OWNER MESSAGES ---
        // Se a mensagem n√£o for do dono, salvamos (j√° feito no webhook) mas N√ÉO processamos na AI.
        // --- FETCH USER SETTINGS (Phone & AI Name) ---
        // Moved up for early filtering
        const { data: userSettingsData } = await supabase
            .from('user_settings')
            .select('phone_number, ai_name')
            .eq('user_id', userId)
            .single();

        const userPhoneNumber = userSettingsData?.phone_number || '';
        const aiName = userSettingsData?.ai_name || 'Assistente';

        // üõë ECONOMY MODE & PRIVACY FILTER
        if (!isOwner) {
            console.log('üõë Economy Mode: Message from non-owner. Skipping AI processing to save tokens.');
            return new Response(JSON.stringify({
                success: true,
                message: 'Message saved but not processed (Economy Mode)',
                skipped: true
            }), {
                headers: { 'Content-Type': 'application/json' }
            });
        } else {
            // Message IS from Owner.
            // Check if it is a "Note to Self" or a Direct Message to someone else.
            // In 'whatsapp-webhook', sender_number is the remoteJid (Recipient) when fromMe is true.

            // Normalize numbers for comparison
            const targetNumber = sender_number?.replace(/\D/g, '') || '';
            const myNumber = userPhoneNumber.replace(/\D/g, '');

            const isNoteToSelf = targetNumber === myNumber;
            const hasTrigger = content?.toLowerCase().match(/\b(bibi|ia|bot|assistente)\b/);

            // If it's a message to someone else AND has no trigger, SKIP.
            if (!isNoteToSelf && !hasTrigger) {
                console.log(`üõë Outgoing message to ${targetNumber} ignored (No trigger).`);
                return new Response(JSON.stringify({
                    success: true,
                    message: 'Outgoing message ignored (No trigger)',
                    skipped: true
                }), {
                    headers: { 'Content-Type': 'application/json' }
                });
            }
        }

        // ESTRAT√âGIA: Usar transcri√ß√£o da Evolution (se dispon√≠vel), sen√£o tentar Whisper como fallback
        console.log('üìù Initial content received:', processedText || 'EMPTY');

        // Tools/Functions dispon√≠veis para o GPT-4o
        const tools = [
            {
                type: 'function',
                function: {
                    name: 'manage_collections',
                    description: 'Gerencia cole√ß√µes (criar ou listar)',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['create', 'list', 'update', 'delete'], description: 'A√ß√£o a realizar' },
                            name: { type: 'string', description: 'Nome da pasta/cole√ß√£o' },
                            description: { type: 'string', description: 'Descri√ß√£o opcional' },
                            icon: { type: 'string', description: 'Emoji para √≠cone (ex: ‚úàÔ∏è, üè†)' },
                            new_name: { type: 'string', description: 'Novo nome (para update)' },
                            force: { type: 'boolean', description: 'For√ßar dele√ß√£o se n√£o vazia' },
                            entity_type: { type: 'string', enum: ['trip', 'project', 'finance_bucket', 'event_list', 'generic'], description: 'Tipo da entidade (OBRIGAT√ìRIO na cria√ß√£o)' },
                            metadata: {
                                type: 'object',
                                description: 'Dados espec√≠ficos do tipo (ex: { status: "planning" } para viagens, { currency: "BRL" } para financeiro).',
                                properties: {
                                    status: { type: 'string', enum: ['planning', 'confirmed', 'completed'], description: 'Status da viagem (Obrigat√≥rio para trip)' },
                                    currency: { type: 'string', enum: ['BRL', 'USD', 'EUR'], description: 'Moeda (Obrigat√≥rio para finance_bucket)' }
                                }
                            }
                        },
                        required: ['action']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'migrate_legacy_collections',
                    description: 'ADMIN ONLY: Migra cole√ß√µes antigas (sem entity_type) para o novo esquema de governan√ßa.',
                    parameters: {
                        type: 'object',
                        properties: {
                            limit: { type: 'number', description: 'Quantas cole√ß√µes processar por vez (padr√£o 5)' },
                            dry_run: { type: 'boolean', description: 'Se true, apenas simula e mostra o que faria' }
                        }
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_financials',
                    description: 'Gerencia GASTOS e RECEITAS. Use para tudo que envolve dinheiro (compras, contas, or√ßamentos).',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['add', 'list', 'delete'], description: 'A√ß√£o' },
                            collection_name: { type: 'string', description: 'Nome da cole√ß√£o (ex: "Viagem Paris", "Obras", "Finan√ßas")' },
                            amount: { type: 'number', description: 'Valor monet√°rio (OBRIGAT√ìRIO). Use ponto para decimais.' },
                            description: { type: 'string', description: 'Descri√ß√£o do gasto (ex: "Uber", "Jantar")' },
                            category: { type: 'string', description: 'Categoria para agrupar (ex: "Transporte", "Alimenta√ß√£o")' },
                            date: { type: 'string', description: 'Data do gasto (ISO). Se omitido, usa hoje.' }
                        },
                        required: ['action', 'collection_name']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_credentials',
                    description: 'Gerencia SENHAS, C√ìDIGOS e DADOS SENS√çVEIS. Seguran√ßa m√°xima.',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['add', 'list', 'delete'], description: 'A√ß√£o' },
                            collection_name: { type: 'string', description: 'Nome da cole√ß√£o (ex: "Senhas", "C√≥digos", "Seguran√ßa")' },
                            service_name: { type: 'string', description: 'Nome do servi√ßo (ex: "Netflix", "Alarme")' },
                            username: { type: 'string', description: 'Login ou usu√°rio' },
                            password: { type: 'string', description: 'A senha ou c√≥digo secreto' },
                            url: { type: 'string', description: 'Link de acesso' },
                            notes: { type: 'string', description: 'Obs adicionais' }
                        },
                        required: ['action', 'collection_name']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_inventory',
                    description: 'Gerencia LISTAS DE ITENS (Malas, Compras, Livros, Filmes). Suporta m√∫ltiplos itens de uma vez.',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['add', 'list', 'delete'], description: 'A√ß√£o' },
                            collection_name: { type: 'string', description: 'Nome da cole√ß√£o (ex: "Mala", "Mercado")' },
                            items: {
                                type: 'array',
                                description: 'Lista de itens para adicionar.',
                                items: {
                                    type: 'object',
                                    properties: {
                                        content: { type: 'string', description: 'Nome do item (ex: "Arroz", "Casaco")' },
                                        quantity: { type: 'string', description: 'Quantidade (ex: "2kg")' },
                                        category: { type: 'string', description: 'Categoria visual (ex: "Higiene", "Carnes")' },
                                        checked: { type: 'boolean', description: 'Se j√° est√° feito/comprado' },
                                        notes: { type: 'string', description: 'Detalhes extras' }
                                    },
                                    required: ['content']
                                }
                            }
                        },
                        required: ['action', 'collection_name', 'items']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_items',
                    description: 'LEGADO/GEN√âRICO: Use APENAS para notas simples ou textos que N√ÉO se encaixam em Financeiro, Credenciais ou Listas.',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['list', 'add', 'update', 'delete'] },
                            collection_name: { type: 'string' },
                            content: { type: 'string' },
                            metadata: { type: 'object', description: 'Metadados gen√©ricos' }
                        },
                        required: ['action', 'collection_name']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_monitors',
                    description: 'Use para MONITORAR conversas e avisar o usu√°rio quando algo espec√≠fico acontecer (ex: "me avise quando mandarem a planilha").',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['create', 'list', 'delete'] },
                            keyword: { type: 'string', description: 'Palavra-chave ou frase para buscar' },
                            chat_name: { type: 'string', description: 'Nome do grupo/chat para monitorar (opcional, null = todos)' },
                            frequency: { type: 'string', enum: ['once', 'always', 'ask'], description: 'once=avisar 1 vez e parar. always=sempre avisar. ask=perguntar se deve parar.' }
                        },
                        required: ['action']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'query_data',
                    description: 'Consulta dados avan√ßada com filtros e agrega√ß√µes',
                    parameters: {
                        type: 'object',
                        properties: {
                            collection_name: { type: 'string', description: 'Nome da cole√ß√£o' },
                            operation: { type: 'string', enum: ['list', 'sum', 'count', 'average'], description: 'Opera√ß√£o' },
                            // Filtros
                            start_date: { type: 'string', description: 'Data inicial (ISO) para filtrar por metadata.date ou created_at' },
                            end_date: { type: 'string', description: 'Data final (ISO) para filtrar por metadata.date ou created_at' },
                            filter_key: { type: 'string', description: 'Filtrar por chave de metadata (ex: category)' },
                            filter_value: { type: 'string', description: 'Filtrar por valor de metadata (ex: alimenta√ß√£o)' },
                            // Agrega√ß√£o
                            field: { type: 'string', description: 'Campo num√©rico para sum/average' }
                        },
                        required: ['collection_name', 'operation']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_reminders',
                    description: 'Gerencia lembretes (criar, listar, atualizar, completar)',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['create', 'list', 'update', 'complete'], description: 'A√ß√£o' },
                            title: { type: 'string', description: 'T√≠tulo do lembrete' },
                            due_at: { type: 'string', description: 'Data/hora (ISO)' },
                            search_title: { type: 'string', description: 'Busca para update/complete' }
                        },
                        required: ['action']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'recall_memory',
                    description: 'Busca mem√≥rias passadas por significado (Busca Vetorial). Use para perguntas vagas ("O que eu falei sobre X?").',
                    parameters: {
                        type: 'object',
                        properties: {
                            query: { type: 'string', description: 'A pergunta ou conceito para buscar na mem√≥ria.' },
                            match_count: { type: 'number', description: 'N√∫mero de mem√≥rias para retornar (default: 5)' }
                        },
                        required: ['query']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'update_user_settings',
                    description: 'Atualiza configura√ß√µes do perfil do usu√°rio, como o nome preferido.',
                    parameters: {
                        type: 'object',
                        properties: {
                            preferred_name: { type: 'string', description: 'Novo nome ou apelido como o usu√°rio quer ser chamado.' },
                            daily_briefing_enabled: { type: 'boolean', description: 'Ativar ou desativar o Resumo Di√°rio.' },
                            daily_briefing_time: { type: 'string', description: 'Hor√°rio do resumo (formato HH:MM, ex: "08:00").' },
                            daily_briefing_prompt: { type: 'string', description: 'Instru√ß√µes personalizadas para o resumo (ex: "Seja engra√ßado").' },
                            ai_name: { type: 'string', description: 'Novo nome para a IA (ex: "Jarvis").' }
                        }
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'send_whatsapp_message',
                    description: 'Envia uma mensagem de WhatsApp para um n√∫mero espec√≠fico. Use APENAS se o usu√°rio pedir explicitamente ("Mande mensagem para X").',
                    parameters: {
                        type: 'object',
                        properties: {
                            number: { type: 'string', description: 'N√∫mero do destinat√°rio (com DDI e DDD, ex: 5511999999999)' },
                            message: { type: 'string', description: 'Conte√∫do da mensagem' }
                        },
                        required: ['number', 'message']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'query_messages',
                    description: 'Consulta o hist√≥rico de mensagens do WhatsApp. OBRIGAT√ìRIO usar se o usu√°rio perguntar "o que fulano disse?", "veja a mensagem de X", ou pedir resumo de conversa.',
                    parameters: {
                        type: 'object',
                        properties: {
                            sender_number: { type: 'string', description: 'Filtrar por n√∫mero do remetente' },
                            sender_name: { type: 'string', description: 'Filtrar por nome do remetente (ex: "Bianca")' },
                            group_name: { type: 'string', description: 'Filtrar por nome do grupo (ex: "Fam√≠lia", "Trabalho")' },
                            limit: { type: 'number', description: 'N√∫mero de mensagens (default: 20)' },
                            days_ago: { type: 'number', description: 'Quantos dias atr√°s buscar (default: 7)' }
                        }
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'save_memory',
                    description: 'Salva uma informa√ß√£o importante na Mem√≥ria de Longo Prazo (Vetorial). Use para fatos, prefer√™ncias ou decis√µes que o usu√°rio quer que voc√™ lembre para sempre.',
                    parameters: {
                        type: 'object',
                        properties: {
                            content: { type: 'string', description: 'O conte√∫do exato a ser memorizado.' },
                            category: { type: 'string', description: 'Categoria opcional (ex: prefer√™ncia, fato, decis√£o)' }
                        },
                        required: ['content']
                    }
                }
            },

            {
                type: 'function',
                function: {
                    name: 'manage_rules',
                    description: 'Gerencia as Regras e Prefer√™ncias do usu√°rio (Brain). Use isso para salvar instru√ß√µes permanentes sobre como o usu√°rio gosta que voc√™ se comporte.',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['create', 'delete', 'list'], description: 'A√ß√£o a realizar' },
                            key: { type: 'string', description: 'T√≥pico da regra (ex: "Tom de voz", "Formata√ß√£o", "Hor√°rios")' },
                            value: { type: 'string', description: 'A regra em si (ex: "Seja sempre formal", "Use listas com emojis")' },
                            id: { type: 'string', description: 'ID da regra (para delete)' }
                        },
                        required: ['action']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_users',
                    description: 'ADMIN ONLY: Manage users, models and rules. Use this to list users, change their AI model, or delete them.',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['list', 'update_model', 'delete', 'update_rules'] },
                            target_user_id: { type: 'string', description: 'The ID of the user to modify (required for update/delete)' },
                            model: { type: 'string', enum: ['gpt-4o', 'gpt-5.1-preview'], description: 'New model to set' },
                            rule_key: { type: 'string', description: 'Key of the rule to update' },
                            rule_value: { type: 'string', description: 'Value of the rule to update' }
                        },
                        required: ['action']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_emails',
                    description: 'Gerencia emails do Gmail (ler, enviar, responder, mover, apagar).',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: { type: 'string', enum: ['list', 'read', 'send', 'reply', 'move_to_trash', 'archive', 'mark_as_read'], description: 'A√ß√£o a realizar' },
                            provider: { type: 'string', enum: ['google', 'microsoft', 'all'], description: 'Provedor (opcional, default: all)' },
                            // List
                            query: { type: 'string', description: 'Busca (ex: "from:amazon", "is:unread")' },
                            limit: { type: 'number', description: 'Limite de emails (default: 5)' },
                            // Read/Move/Reply
                            email_id: { type: 'string', description: 'ID do email (obrigat√≥rio para read/move/reply)' },
                            // Send/Reply
                            to: { type: 'string', description: 'Destinat√°rio (email)' },
                            subject: { type: 'string', description: 'Assunto' },
                            body: { type: 'string', description: 'Corpo do email (pode ser HTML ou texto)' }
                        },
                        required: ['action']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'manage_calendar',
                    description: 'Gerencia o CALEND√ÅRIO REAL (Google/Outlook). Use para agendar reuni√µes, consultar agenda e ver disponibilidade.',
