import"jsr:@supabase/functions-js/edge-runtime.d.ts";import{createClient as $e}from"jsr:@supabase/supabase-js@2";function ee(O,D,d){let $=O.due_at||null;if(O.time_config){const{mode:c}=O.time_config,m=new Date(D.getTime());if(console.log(`\u{1F9E0} TIME CONFIG RECEIVED: Mode = ${c} `,O.time_config),c==="relative"){const{relative_amount:v,relative_unit:q}=O.time_config;v&&q&&(q==="minutes"?m.setMinutes(m.getMinutes()+v):q==="hours"?m.setHours(m.getHours()+v):q==="days"&&m.setDate(m.getDate()+v),$=m.toISOString().replace("Z","-03:00"))}else if(c==="absolute"){const{target_day:v,target_month:q,target_year:T,target_hour:B,target_minute:x}=O.time_config;T&&m.setFullYear(T),q&&m.setMonth(q-1),v&&m.setDate(v),B!==void 0?m.setHours(B):m.setHours(9),x!==void 0?m.setMinutes(x):m.setMinutes(0),$=m.toISOString().replace("Z","-03:00")}}else if(O.relative_time&&O.relative_time.amount){const{amount:c,unit:m}=O.relative_time,v=new Date(D.getTime());m==="minutes"?v.setMinutes(v.getMinutes()+c):m==="hours"?v.setHours(v.getHours()+c):m==="days"&&v.setDate(v.getDate()+c),$=v.toISOString().replace("Z","-03:00")}else d&&($=d);return $}Deno.serve(async O=>{if(O.method==="OPTIONS")return new Response(null,{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"authorization, x-client-info, apikey, content-type"}});try{const{content:D,mediaUrl:d,mediaType:$,userId:c,messageId:m,is_owner:v,sender_name:q,sender_number:T,is_group:B,group_name:x}=await O.json();console.log(`\u{1F680} Process Message HIT: ${D?.substring(0,50)}...`);const ge=Deno.env.get("SUPABASE_URL"),fe=Deno.env.get("SUPABASE_SERVICE_ROLE_KEY"),r=$e(ge,fe),F=Deno.env.get("OPENAI_API_KEY");if(!F)return new Response(JSON.stringify({success:!1,error:"OpenAI API key not configured"}),{status:500,headers:{"Content-Type":"application/json"}});let I=D||"";const J=v!==!1,te=q||"Desconhecido",be=`
CONTEXTO ATUAL:
- Data/Hora: ${new Date().toISOString()}
- Usu\xE1rio: ${c}
- Canal: WhatsApp ${B?"(GRUPO)":"(PRIVADO)"}
- Remetente da Mensagem: ${q||"Desconhecido"} (${T||"?"})
- Voc\xEA \xE9 o Dono? ${J?"SIM":"N\xC3O"}
`;console.log(`\u{1F464} Sender: ${te} (${T||"?"}) | Is Owner: ${J}`);const{data:oe}=await r.from("user_settings").select("phone_number, ai_name").eq("user_id",c).single(),ne=oe?.phone_number||"",_e=oe?.ai_name||"Assistente";if(J){const p=T?.replace(/\D/g,"")||"",g=ne.replace(/\D/g,""),b=p===g,S=D?.toLowerCase().match(/\b(bibi|ia|bot|assistente)\b/);if(!b&&!S)return console.log(`\u{1F6D1} Outgoing message to ${p} ignored (No trigger).`),new Response(JSON.stringify({success:!0,message:"Outgoing message ignored (No trigger)",skipped:!0}),{headers:{"Content-Type":"application/json"}})}else return console.log("\u{1F6D1} Economy Mode: Message from non-owner. Skipping AI processing to save tokens."),new Response(JSON.stringify({success:!0,message:"Message saved but not processed (Economy Mode)",skipped:!0}),{headers:{"Content-Type":"application/json"}});console.log("\u{1F4DD} Initial content received:",I||"EMPTY");const H=[{type:"function",function:{name:"manage_collections",description:"Gerencia cole\xE7\xF5es (criar ou listar)",parameters:{type:"object",properties:{action:{type:"string",enum:["create","list","update","delete"],description:"A\xE7\xE3o a realizar"},name:{type:"string",description:"Nome da pasta/cole\xE7\xE3o"},description:{type:"string",description:"Descri\xE7\xE3o opcional"},icon:{type:"string",description:"Emoji para \xEDcone (ex: \u2708\uFE0F, \u{1F3E0})"},new_name:{type:"string",description:"Novo nome (para update)"},force:{type:"boolean",description:"For\xE7ar dele\xE7\xE3o se n\xE3o vazia"},entity_type:{type:"string",enum:["trip","project","finance_bucket","event_list","generic"],description:"Tipo da entidade (OBRIGAT\xD3RIO na cria\xE7\xE3o)"},metadata:{type:"object",description:'Dados espec\xEDficos do tipo (ex: { status: "planning" } para viagens, { currency: "BRL" } para financeiro).',properties:{status:{type:"string",enum:["planning","confirmed","completed"],description:"Status da viagem (Obrigat\xF3rio para trip)"},currency:{type:"string",enum:["BRL","USD","EUR"],description:"Moeda (Obrigat\xF3rio para finance_bucket)"}}}},required:["action"]}}},{type:"function",function:{name:"migrate_legacy_collections",description:"ADMIN ONLY: Migra cole\xE7\xF5es antigas (sem entity_type) para o novo esquema de governan\xE7a.",parameters:{type:"object",properties:{limit:{type:"number",description:"Quantas cole\xE7\xF5es processar por vez (padr\xE3o 5)"},dry_run:{type:"boolean",description:"Se true, apenas simula e mostra o que faria"}}}}},{type:"function",function:{name:"manage_financials",description:"Gerencia GASTOS e RECEITAS. Use para tudo que envolve dinheiro (compras, contas, or\xE7amentos).",parameters:{type:"object",properties:{action:{type:"string",enum:["add","list","delete"],description:"A\xE7\xE3o"},collection_name:{type:"string",description:'Nome da cole\xE7\xE3o (ex: "Viagem Paris", "Obras", "Finan\xE7as")'},amount:{type:"number",description:"Valor monet\xE1rio (OBRIGAT\xD3RIO). Use ponto para decimais."},description:{type:"string",description:'Descri\xE7\xE3o do gasto (ex: "Uber", "Jantar")'},category:{type:"string",description:'Categoria para agrupar (ex: "Transporte", "Alimenta\xE7\xE3o")'},date:{type:"string",description:"Data do gasto (ISO). Se omitido, usa hoje."}},required:["action","collection_name"]}}},{type:"function",function:{name:"manage_credentials",description:"Gerencia SENHAS, C\xD3DIGOS e DADOS SENS\xCDVEIS. Seguran\xE7a m\xE1xima.",parameters:{type:"object",properties:{action:{type:"string",enum:["add","list","delete"],description:"A\xE7\xE3o"},collection_name:{type:"string",description:'Nome da cole\xE7\xE3o (ex: "Senhas", "C\xF3digos", "Seguran\xE7a")'},service_name:{type:"string",description:'Nome do servi\xE7o (ex: "Netflix", "Alarme")'},username:{type:"string",description:"Login ou usu\xE1rio"},password:{type:"string",description:"A senha ou c\xF3digo secreto"},url:{type:"string",description:"Link de acesso"},notes:{type:"string",description:"Obs adicionais"}},required:["action","collection_name"]}}},{type:"function",function:{name:"manage_inventory",description:"Gerencia LISTAS DE ITENS (Malas, Compras, Livros, Filmes). Suporta m\xFAltiplos itens de uma vez.",parameters:{type:"object",properties:{action:{type:"string",enum:["add","list","delete"],description:"A\xE7\xE3o"},collection_name:{type:"string",description:'Nome da cole\xE7\xE3o (ex: "Mala", "Mercado")'},items:{type:"array",description:"Lista de itens para adicionar.",items:{type:"object",properties:{content:{type:"string",description:'Nome do item (ex: "Arroz", "Casaco")'},quantity:{type:"string",description:'Quantidade (ex: "2kg")'},category:{type:"string",description:'Categoria visual (ex: "Higiene", "Carnes")'},checked:{type:"boolean",description:"Se j\xE1 est\xE1 feito/comprado"},notes:{type:"string",description:"Detalhes extras"}},required:["content"]}}},required:["action","collection_name","items"]}}},{type:"function",function:{name:"manage_items",description:"LEGADO/GEN\xC9RICO: Use APENAS para notas simples ou textos que N\xC3O se encaixam em Financeiro, Credenciais ou Listas.",parameters:{type:"object",properties:{action:{type:"string",enum:["list","add","update","delete"]},collection_name:{type:"string"},content:{type:"string"},metadata:{type:"object",description:"Metadados gen\xE9ricos"}},required:["action","collection_name"]}}},{type:"function",function:{name:"manage_monitors",description:'Use para MONITORAR conversas e avisar o usu\xE1rio quando algo espec\xEDfico acontecer (ex: "me avise quando mandarem a planilha").',parameters:{type:"object",properties:{action:{type:"string",enum:["create","list","delete"]},keyword:{type:"string",description:"Palavra-chave ou frase para buscar"},chat_name:{type:"string",description:"Nome do grupo/chat para monitorar (opcional, null = todos)"},frequency:{type:"string",enum:["once","always","ask"],description:"once=avisar 1 vez e parar. always=sempre avisar. ask=perguntar se deve parar."}},required:["action"]}}},{type:"function",function:{name:"query_data",description:"Consulta dados avan\xE7ada com filtros e agrega\xE7\xF5es",parameters:{type:"object",properties:{collection_name:{type:"string",description:"Nome da cole\xE7\xE3o"},operation:{type:"string",enum:["list","sum","count","average"],description:"Opera\xE7\xE3o"},start_date:{type:"string",description:"Data inicial (ISO) para filtrar por metadata.date ou created_at"},end_date:{type:"string",description:"Data final (ISO) para filtrar por metadata.date ou created_at"},filter_key:{type:"string",description:"Filtrar por chave de metadata (ex: category)"},filter_value:{type:"string",description:"Filtrar por valor de metadata (ex: alimenta\xE7\xE3o)"},field:{type:"string",description:"Campo num\xE9rico para sum/average"}},required:["collection_name","operation"]}}},{type:"function",function:{name:"manage_reminders",description:"Gerencia lembretes (criar, listar, atualizar, completar)",parameters:{type:"object",properties:{action:{type:"string",enum:["create","list","update","complete"],description:"A\xE7\xE3o"},title:{type:"string",description:"T\xEDtulo do lembrete"},due_at:{type:"string",description:"Data/hora (ISO)"},search_title:{type:"string",description:"Busca para update/complete"}},required:["action"]}}},{type:"function",function:{name:"recall_memory",description:'Busca mem\xF3rias passadas por significado (Busca Vetorial). Use para perguntas vagas ("O que eu falei sobre X?").',parameters:{type:"object",properties:{query:{type:"string",description:"A pergunta ou conceito para buscar na mem\xF3ria."},match_count:{type:"number",description:"N\xFAmero de mem\xF3rias para retornar (default: 5)"}},required:["query"]}}},{type:"function",function:{name:"update_user_settings",description:"Atualiza configura\xE7\xF5es do perfil do usu\xE1rio, como o nome preferido.",parameters:{type:"object",properties:{preferred_name:{type:"string",description:"Novo nome ou apelido como o usu\xE1rio quer ser chamado."},daily_briefing_enabled:{type:"boolean",description:"Ativar ou desativar o Resumo Di\xE1rio."},daily_briefing_time:{type:"string",description:'Hor\xE1rio do resumo (formato HH:MM, ex: "08:00").'},daily_briefing_prompt:{type:"string",description:'Instru\xE7\xF5es personalizadas para o resumo (ex: "Seja engra\xE7ado").'},ai_name:{type:"string",description:'Novo nome para a IA (ex: "Jarvis").'}}}}},{type:"function",function:{name:"send_whatsapp_message",description:'Envia uma mensagem de WhatsApp para um n\xFAmero espec\xEDfico. Use APENAS se o usu\xE1rio pedir explicitamente ("Mande mensagem para X").',parameters:{type:"object",properties:{number:{type:"string",description:"N\xFAmero do destinat\xE1rio (com DDI e DDD, ex: 5511999999999)"},message:{type:"string",description:"Conte\xFAdo da mensagem"}},required:["number","message"]}}},{type:"function",function:{name:"query_messages",description:'Consulta o hist\xF3rico de mensagens do WhatsApp. OBRIGAT\xD3RIO usar se o usu\xE1rio perguntar "o que fulano disse?", "veja a mensagem de X", ou pedir resumo de conversa.',parameters:{type:"object",properties:{sender_number:{type:"string",description:"Filtrar por n\xFAmero do remetente"},sender_name:{type:"string",description:'Filtrar por nome do remetente (ex: "Bianca")'},group_name:{type:"string",description:'Filtrar por nome do grupo (ex: "Fam\xEDlia", "Trabalho")'},limit:{type:"number",description:"N\xFAmero de mensagens (default: 20)"},days_ago:{type:"number",description:"Quantos dias atr\xE1s buscar (default: 7)"}}}}},{type:"function",function:{name:"save_memory",description:"Salva uma informa\xE7\xE3o importante na Mem\xF3ria de Longo Prazo (Vetorial). Use para fatos, prefer\xEAncias ou decis\xF5es que o usu\xE1rio quer que voc\xEA lembre para sempre.",parameters:{type:"object",properties:{content:{type:"string",description:"O conte\xFAdo exato a ser memorizado."},category:{type:"string",description:"Categoria opcional (ex: prefer\xEAncia, fato, decis\xE3o)"}},required:["content"]}}},{type:"function",function:{name:"manage_rules",description:"Gerencia as Regras e Prefer\xEAncias do usu\xE1rio (Brain). Use isso para salvar instru\xE7\xF5es permanentes sobre como o usu\xE1rio gosta que voc\xEA se comporte.",parameters:{type:"object",properties:{action:{type:"string",enum:["create","delete","list"],description:"A\xE7\xE3o a realizar"},key:{type:"string",description:'T\xF3pico da regra (ex: "Tom de voz", "Formata\xE7\xE3o", "Hor\xE1rios")'},value:{type:"string",description:'A regra em si (ex: "Seja sempre formal", "Use listas com emojis")'},id:{type:"string",description:"ID da regra (para delete)"}},required:["action"]}}},{type:"function",function:{name:"manage_users",description:"ADMIN ONLY: Manage users, models and rules. Use this to list users, change their AI model, or delete them.",parameters:{type:"object",properties:{action:{type:"string",enum:["list","update_model","delete","update_rules"]},target_user_id:{type:"string",description:"The ID of the user to modify (required for update/delete)"},model:{type:"string",enum:["gpt-4o","gpt-5.1-preview"],description:"New model to set"},rule_key:{type:"string",description:"Key of the rule to update"},rule_value:{type:"string",description:"Value of the rule to update"}},required:["action"]}}},{type:"function",function:{name:"manage_emails",description:"Gerencia emails do Gmail (ler, enviar, responder, mover, apagar).",parameters:{type:"object",properties:{action:{type:"string",enum:["list","read","send","reply","move_to_trash","archive","mark_as_read"],description:"A\xE7\xE3o a realizar"},provider:{type:"string",enum:["google","microsoft","all"],description:"Provedor (opcional, default: all)"},query:{type:"string",description:'Busca (ex: "from:amazon", "is:unread")'},limit:{type:"number",description:"Limite de emails (default: 5)"},email_id:{type:"string",description:"ID do email (obrigat\xF3rio para read/move/reply)"},to:{type:"string",description:"Destinat\xE1rio (email)"},subject:{type:"string",description:"Assunto"},body:{type:"string",description:"Corpo do email (pode ser HTML ou texto)"}},required:["action"]}}},{type:"function",function:{name:"manage_calendar",description:"Gerencia o CALEND\xC1RIO REAL (Google/Outlook). Use para agendar reuni\xF5es, consultar agenda e ver disponibilidade.",parameters:{type:"object",properties:{action:{type:"string",enum:["list_events","create_event","delete_event"],description:"A\xE7\xE3o a realizar"},start_date:{type:"string",description:"Data inicial (ISO) para listar eventos"},end_date:{type:"string",description:"Data final (ISO) para listar eventos"},title:{type:"string",description:"T\xEDtulo do evento"},description:{type:"string",description:"Descri\xE7\xE3o ou detalhes"},start_time:{type:"string",description:"Data/Hora de in\xEDcio (ISO)"},end_time:{type:"string",description:"Data/Hora de fim (ISO). Se n\xE3o informado, assume 1h de dura\xE7\xE3o."},all_day:{type:"boolean",description:"Se \xE9 evento de dia inteiro"},location:{type:"string",description:"Local do evento"},provider:{type:"string",enum:["google","microsoft"],description:"Provedor espec\xEDfico (opcional)"},event_id:{type:"string",description:"ID do evento para deletar"}},required:["action"]}}}];H.push({type:"function",function:{name:"global_search",description:"Busca GLOBAL em todas as cole\xE7\xF5es, lembretes e itens. Use quando n\xE3o souber onde algo est\xE1 salvo ou se a busca espec\xEDfica falhar.",parameters:{type:"object",properties:{query:{type:"string",description:'Termo de busca (ex: "senha porta", "compras", "ideia")'},limit:{type:"number",description:"Limite de resultados (default: 10)"}},required:["query"]}}}),H.push({type:"function",function:{name:"get_unread_conversations",description:'Recupera uma lista de conversas onde a \xFAltima mensagem N\xC3O foi enviada pelo usu\xE1rio (ou seja, est\xE1 "n\xE3o lida" ou aguardando resposta).',parameters:{type:"object",properties:{limit:{type:"number",description:"N\xFAmero m\xE1ximo de conversas para retornar (padr\xE3o: 20)"},offset:{type:"number",description:"Pagina\xE7\xE3o (padr\xE3o: 0)"}}}}});const ie=new Date,U=new Date(ie.getTime()-10800*1e3),se=U.toISOString().replace("Z","-03:00");console.log("\u{1F50D} DEBUG - Server Time (UTC):",ie.toISOString()),console.log("\u{1F50D} DEBUG - Brasilia Time (Calculated):",se);let V=null;const ye=/(?:daqui|em)(?:\s+a)?\s+(\d+|um|uma|dois|duas|trÃªs|quatro|cinco|dez|quinze|vinte|trinta|meia)\s+(minuto|minutos|hora|horas|dia|dias)/i,K=I.match(ye),re={um:1,uma:1,dois:2,duas:2,tr\u00EAs:3,quatro:4,cinco:5,dez:10,quinze:15,vinte:20,trinta:30,meia:.5};if(K){let p=0;const g=K[1].toLowerCase();isNaN(parseInt(g))?re[g]&&(p=re[g]):p=parseInt(g);const b=K[2].toLowerCase(),S=new Date(U.getTime());p>0&&(b.includes("minuto")?S.setMinutes(S.getMinutes()+p):b.includes("hora")?g==="meia"?S.setMinutes(S.getMinutes()+30):S.setHours(S.getHours()+p):b.includes("dia")&&S.setDate(S.getDate()+p),V=S.toISOString().replace("Z","-03:00"),console.log(`\u{1F6E1}\uFE0F SAFETY: Detected relative time "${K[0]}". Calculated override: ${V}`))}let C="You are Ela.ia. Please check database for full prompt.";try{const{data:p,error:g}=await r.from("prompts").select("content").eq("key","system_core").eq("is_active",!0).maybeSingle();p&&p.content?(C=p.content,console.log('\u2705 PROMPT REGISTRY: Loaded "system_core" from DB.')):(console.warn('\u26A0\uFE0F PROMPT REGISTRY: "system_core" not found or inactive. Using fallback.'),g&&console.error("Prompt fetch error:",g))}catch(p){console.error("\u274C PROMPT REGISTRY CRITICAL FAILURE:",p)}let W="gpt-5.1-preview",M=null;try{const{data:p}=await r.from("user_settings").select("custom_system_prompt, ai_model, preferred_name, ai_name").eq("user_id",c).maybeSingle();if(M=p,M?.custom_system_prompt&&console.log("\u26A0\uFE0F IGNORING user_settings.custom_system_prompt in favor of Registry."),typeof C=="string"){const S=M?.preferred_name||"Usu\xE1rio";C=C.replace("{{preferred_name}}",S).replace("{{CURRENT_DATETIME}}",se)}console.log("\u2728 Enforcing GPT 5.1 for all users."),W="gpt-5.1-preview";const g=M?.ai_name;g&&(C+=`

SEU NOME: Seu nome \xE9 "${g}". Se apresente assim se perguntarem.`);const b=M?.preferred_name||"Usu\xE1rio";C+=`

NOME DO USU\xC1RIO: O nome/apelido do usu\xE1rio \xE9 "${b}". Chame-o assim sempre que poss\xEDvel para ser mais pessoal.`,console.log(`\u{1F464} Preferred Name Injected: ${b}`),J||M?.is_admin?(C+=`

STATUS: Voc\xEA est\xE1 falando com o SEU DONO/ADMIN (${b}). Voc\xEA tem permiss\xE3o total para executar comandos, criar tarefas, salvar mem\xF3rias e gerenciar o sistema.`,M?.is_admin&&(C+=`

\u{1F6E1}\uFE0F MODO ADMIN ATIVADO: Voc\xEA tem acesso \xE0 ferramenta \`manage_users\`.
Use-a para listar usu\xE1rios, mudar modelos de IA (gpt-4o, gpt-5.1-preview) ou gerenciar regras.
Se o admin pedir "Liste os usu\xE1rios", use \`manage_users { action: 'list' }\`.
Se o admin pedir "Mude o modelo do Jo\xE3o para GPT-4o", use \`manage_users { action: 'update_model', ... }\`.`)):C+=`

\u26A0\uFE0F ALERTA DE SEGURAN\xC7A - MODO RESTRITO \u26A0\uFE0F
Voc\xEA est\xE1 falando com TERCEIROS (${te}), N\xC3O com o seu dono.
REGRAS ABSOLUTAS:
1. VOC\xCA \xC9 PROIBIDO DE EXECUTAR COMANDOS que alterem o sistema (criar tarefas, mudar configura\xE7\xF5es, deletar mem\xF3rias, gerenciar emails/calend\xE1rio).
2. Se a pessoa pedir para fazer algo ("Cria uma tarefa", "Muda meu nome"), RECUSE educadamente: "Desculpe, apenas meu dono pode fazer isso."
3. Voc\xEA PODE conversar, tirar d\xFAvidas e ser simp\xE1tico, mas aja como uma secret\xE1ria/assistente pessoal que protege a agenda do chefe.
4. Se perguntarem sobre o ${b}, responda com base no que voc\xEA sabe, mas n\xE3o revele dados sens\xEDveis (senhas, endere\xE7os privados).`}catch(p){console.error("Error loading user settings:",p)}console.log("\u{1F916} AI Model:",W),console.log("\u{1F4DD} System Prompt (primeiras 100 chars):",C.substring(0,100)+"..."),console.log("\u2705 Custom settings loaded:",!!M);const{data:he}=await r.from("collections").select("name").eq("user_id",c),ce=he?.map(p=>p.name).join(", ")||"Nenhuma";console.log(`\u{1F4C2} Existing Collections: ${ce}`),C+=`

CONTEXTO DE DADOS ATUAL: 
 - Cole\xE7\xF5es / Pastas Existentes: [${ce}]
 - Use essas pastas se apropriado antes de criar novas.`;const{data:Q}=await r.from("user_preferences").select("key, value").eq("user_id",c);if(Q&&Q.length>0){const p=Q.map(g=>`- [${g.key}]: ${g.value}`).join(`
`);C+=`

REGRAS APRENDIDAS (PREFER\xCANCIAS DO USU\xC1RIO):
${p}
(Siga estas regras acima de tudo).`,console.log(`\u{1F9E0} Injected ${Q.length} user rules.`)}if($==="audio"&&d)if(await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:"Starting audio processing",meta:{mediaUrlLength:d.length,isDataUri:d.startsWith("data:")}}),I&&!I.includes("[\xC1udio")&&!I.includes("processando")&&I.length>3)console.log("\u2705 Using Evolution API transcription (PT-BR):",I),await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:"Using Evolution transcription",meta:{text:I}});else{console.log("\u26A0\uFE0F No useful text from Evolution - attempting Whisper fallback...");try{let g;if(d.startsWith("data:")){console.log("Processing Data URI...");const h=d.split(",")[1],e=d.split(";")[0].split(":")[1],s=atob(h),n=new Uint8Array(s.length);for(let t=0;t<s.length;t++)n[t]=s.charCodeAt(t);g=new Blob([n],{type:e}),console.log(`\u2705 Converted Base64 to Blob: ${g.size} bytes, type: ${e}`),await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:"Converted Base64 to Blob",meta:{size:g.size,type:e}})}else{console.log("\u{1F4E5} Downloading audio from URL:",d);const h=await fetch(d);if(!h.ok)throw console.error(`\u274C Failed to fetch audio: ${h.status} `),await r.from("debug_logs").insert({function_name:"process-message",level:"error",message:"Failed to fetch audio URL",meta:{status:h.status,url:d}}),new Error(`Failed to fetch audio: ${h.status}`);g=await h.blob(),console.log(`\u2705 Audio downloaded: ${g.size} bytes`)}const b=new FormData;b.append("file",g,"audio.ogg"),b.append("model","whisper-1"),b.append("language","pt"),b.append("prompt","Esta \xE9 uma mensagem de \xE1udio em portugu\xEAs brasileiro. Transcrever em portugu\xEAs do Brasil."),b.append("temperature","0"),console.log("\u{1F680} Sending to Whisper API...");const k=await(await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${F}`},body:b})).json();k.text?(console.log("\u2705 Whisper Fallback SUCCESS:",k.text),I=k.text,await r.from("debug_logs").insert({function_name:"process-message",level:"success",message:"Whisper Transcription Success",meta:{text:k.text}})):(console.error("\u274C Whisper Error:",k),await r.from("debug_logs").insert({function_name:"process-message",level:"error",message:"Whisper API Error",meta:k}),k.error?.message?.includes("Invalid file format")?I="O \xE1udio est\xE1 criptografado ou em formato inv\xE1lido.":I="N\xE3o foi poss\xEDvel transcrever o \xE1udio.")}catch(g){console.error("\u274C Error processing audio:",g),await r.from("debug_logs").insert({function_name:"process-message",level:"error",message:"Audio processing exception",meta:{error:g.message,stack:g.stack}}),I="Erro ao processar \xE1udio. Por favor, envie novamente."}}if(console.log("\u{1F4DD} FINAL TEXT SENT TO AI:",I),m&&I&&$==="audio"&&(console.log(`\u{1F4BE} Updating transcription for message ${m}...`),await r.from("messages").update({content:I}).eq("id",m)),I&&!J){const{data:p}=await r.from("monitors").select("*").eq("user_id",c).eq("is_active",!0);if(p&&p.length>0){const g=p.filter(b=>{const S=I.toLowerCase().includes(b.keyword.toLowerCase()),k=!b.chat_name||x&&x.toLowerCase().includes(b.chat_name.toLowerCase());return S&&k});g.length>0&&(console.log(`\u{1F514} MONITOR TRIGGERED: ${g.length} matches found.`),C+=`

\u{1F6A8} ALERTA DE MONITORAMENTO: A mensagem acima contem "${g[0].keyword}" que voc\xEA estava monitorando!
                    A\xE7\xE3o Obrigat\xF3ria: Avise o usu\xE1rio IMEDIATAMENTE.
                    Mensagem: "${I}"
                    Contexto: ${x||"Chat Privado"}
                    Regra: ${g[0].frequency} (Se for 'once', avise que vai parar de monitorar. Se for 'ask', pergunte se deve parar).`)}}const{data:le}=await r.from("messages").select("role, content").eq("user_id",c).order("created_at",{ascending:!1}).limit(10),de=(le?le.reverse():[]).filter(p=>p.content!==I);console.log(`\u{1F9E0} Context loaded: ${de.length} previous messages.`);const z=[{role:"system",content:C||DEFAULT_SYSTEM_PROMPT},...de.map(p=>({role:p.role,content:p.content||(p.media_url?"[Media Message]":"")}))];d&&$!=="audio"&&z.push({role:"system",content:`[User attached a file / media.URL: ${d} (Type: ${$})]`}),d&&$==="image"?z.push({role:"user",content:[{type:"text",text:I},{type:"image_url",image_url:{url:d}}]}):z.push({role:"user",content:I});let me=0;const we=5;let X="";for(;me<we;){me++;let p=W;console.log(`\u{1F916} Final Model for Inference: ${p} (Requested: ${W})`);let g=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},body:JSON.stringify({model:p,messages:z,tools:H,tool_choice:"auto",temperature:.7})});!g.ok&&p==="gpt-5.1-preview"&&(console.warn("\u26A0\uFE0F GPT 5.1 failed (likely not available). Falling back to GPT-4o."),await r.from("debug_logs").insert({function_name:"process-message",level:"warning",message:"GPT 5.1 failed, falling back to GPT-4o",meta:{status:g.status}}),p="gpt-4o",g=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},body:JSON.stringify({model:p,messages:z,tools:H,tool_choice:"auto",temperature:.7})}));const b=await g.json();if(!b.choices?.[0])throw console.error("GPT Error:",b),new Error("Erro na comunica\xE7\xE3o com a AI");const S=b.choices[0].message;if(z.push(S),S.content&&console.log("\u{1F4AD} THOUGHT:",S.content),!S.tool_calls||S.tool_calls.length===0){X=S.content;break}for(const k of S.tool_calls){const h=k.function.name,e=JSON.parse(k.function.arguments);console.log(`\u{1F527} TOOL CALL: ${h}`),console.log("\u{1F527} ARGS:",JSON.stringify(e));let s="";try{if(!J)throw console.warn(`\u{1F6D1} BLOCKED TOOL EXECUTION: ${h} called by non-owner (${te})`),new Error(`\u26D4 A\xE7\xE3o Bloqueada: Apenas o dono (${M?.preferred_name||"Vitor"}) pode executar comandos.`);if(await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:`Executing tool: ${h}`,meta:{args:e}}),h==="manage_collections")s=await ve(r,c,e);else if(h==="manage_financials"){if(e.action==="add")if(!e.amount)s="Erro: 'amount' \xE9 obrigat\xF3rio para finan\xE7as. Pergunte ao usu\xE1rio o valor.";else{let n=null;const{data:t}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(t)n=t.id;else{const{data:a}=await r.from("collections").insert({user_id:c,name:e.collection_name,icon:"\u{1F4B0}"}).select().single();n=a.id}const{error:o}=await r.from("collection_items").insert({collection_id:n,user_id:c,type:"expense",content:e.description||"Gasto sem descri\xE7\xE3o",metadata:{amount:e.amount,category:e.category||"Geral",section:e.category||"Geral",date:e.date||new Date().toISOString()}});o?s=`Erro ao salvar gasto: ${o.message}`:s=`Gasto de ${e.amount} salvo em "${e.collection_name}".`}else if(e.action==="list")s="Use query_data para listar finan\xE7as com filtros.";else if(e.action==="delete"){const{data:n}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!n)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",n.id).eq("type","expense");e.description&&(t=t.ilike("content",`%${e.description}%`)),e.amount&&(t=t.eq("metadata->>amount",e.amount));const{data:o}=await t.limit(5);!o||o.length===0?s="Erro: Item financeiro n\xE3o encontrado para exclus\xE3o.":o.length>1?s=`M\xFAltiplos itens encontrados. Qual apagar?
${o.map(i=>`- ${i.content} (R$ ${i.metadata.amount})`).join(`
`)}`:(await r.from("collection_items").delete().eq("id",o[0].id),s="Gasto removido com sucesso.")}}else if(e.action==="update"){const{data:n}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!n)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",n.id).eq("type","expense");e.description&&(t=t.ilike("content",`%${e.description}%`)),e.search_amount&&(t=t.eq("metadata->>amount",e.search_amount));const{data:o}=await t.limit(5);if(!o||o.length===0)s="Erro: Item financeiro n\xE3o encontrado para atualiza\xE7\xE3o.";else if(o.length>1)s=`M\xFAltiplos itens encontrados. Qual atualizar?
${o.map(i=>`- ${i.content} (R$ ${i.metadata.amount})`).join(`
`)}`;else{const a=o[0],i={...a.metadata};e.amount&&(i.amount=e.amount),e.category&&(i.category=e.category,i.section=e.category),e.date&&(i.date=e.date),await r.from("collection_items").update({content:e.new_description||a.content,metadata:i}).eq("id",a.id),s="Gasto atualizado com sucesso."}}}}else if(h==="manage_credentials"){if(e.action==="add"){let n=null;const{data:t}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(t)n=t.id;else{const{data:a}=await r.from("collections").insert({user_id:c,name:e.collection_name,icon:"\u{1F512}"}).select().single();n=a.id}const{error:o}=await r.from("collection_items").insert({collection_id:n,user_id:c,type:"credential",content:e.service_name||"Credencial",metadata:{username:e.username,password:e.password,url:e.url,notes:e.notes,type:"credential"}});o?s=`Erro ao salvar credencial: ${o.message}`:s=`Credencial para "${e.service_name}" salva com seguran\xE7a.`}else if(e.action==="delete"){const{data:n}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!n)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",n.id).eq("type","credential");e.service_name&&(t=t.ilike("content",`%${e.service_name}%`)),e.username&&(t=t.eq("metadata->>username",e.username));const{data:o}=await t.limit(5);!o||o.length===0?s="Erro: Credencial n\xE3o encontrada para exclus\xE3o.":o.length>1?s=`M\xFAltiplas credenciais encontradas. Qual apagar?
${o.map(i=>`- ${i.content} (User: ${i.metadata.username})`).join(`
`)}`:(await r.from("collection_items").delete().eq("id",o[0].id),s="Credencial removida com sucesso.")}}else if(e.action==="update"){const{data:n}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!n)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",n.id).eq("type","credential");e.service_name&&(t=t.ilike("content",`%${e.service_name}%`)),e.username&&(t=t.eq("metadata->>username",e.username));const{data:o}=await t.limit(5);if(!o||o.length===0)s="Erro: Credencial n\xE3o encontrada para atualiza\xE7\xE3o.";else if(o.length>1)s=`M\xFAltiplas credenciais encontradas. Qual atualizar?
${o.map(i=>`- ${i.content} (User: ${i.metadata.username})`).join(`
`)}`;else{const a=o[0],i={...a.metadata};e.new_username&&(i.username=e.new_username),e.new_password&&(i.password=e.new_password),e.url&&(i.url=e.url),e.notes&&(i.notes=e.notes),await r.from("collection_items").update({content:e.new_service_name||a.content,metadata:i}).eq("id",a.id),s="Credencial atualizada com sucesso."}}}}else if(h==="manage_inventory"){if(e.action==="add"){let n=null;const{data:t}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(t)n=t.id;else{const{data:o}=await r.from("collections").insert({user_id:c,name:e.collection_name,icon:"\u{1F4CB}"}).select().single();n=o.id}if(e.items&&e.items.length>0){const o=e.items.map(i=>({collection_id:n,user_id:c,type:"list_item",content:i.content,metadata:{quantity:i.quantity,category:i.category,section:i.category||"Geral",checked:i.checked||!1,notes:i.notes,type:"list_item"}})),{error:a}=await r.from("collection_items").insert(o);a?s=`Erro ao salvar lista: ${a.message}`:s=`${e.items.length} itens adicionados \xE0 lista "${e.collection_name}".`}else s="Nenhum item fornecido para a lista."}else if(e.action==="delete"){const{data:n}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!n)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",n.id).eq("type","list_item");e.content&&(t=t.ilike("content",`%${e.content}%`));const{data:o}=await t.limit(5);!o||o.length===0?s="Erro: Item da lista n\xE3o encontrado para exclus\xE3o.":o.length>1?s=`M\xFAltiplos itens parecidos. Qual apagar?
${o.map(i=>`- ${i.content}`).join(`
`)}`:(await r.from("collection_items").delete().eq("id",o[0].id),s="Item removido da lista com sucesso.")}}else if(e.action==="update"){const{data:n}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!n)s=`Erro: Pasta "${e.collection_name}" n\xE3o encontrada.`;else{let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",n.id).eq("type","list_item");e.content&&(t=t.ilike("content",`%${e.content}%`));const{data:o}=await t.limit(5);if(!o||o.length===0)s="Erro: Item da lista n\xE3o encontrado para atualiza\xE7\xE3o.";else if(o.length>1)s=`M\xFAltiplos itens parecidos. Qual atualizar?
${o.map(i=>`- ${i.content}`).join(`
`)}`;else{const a=o[0],i={...a.metadata};e.quantity&&(i.quantity=e.quantity),e.category&&(i.category=e.category),e.checked!==void 0&&(i.checked=e.checked),e.notes&&(i.notes=e.notes),await r.from("collection_items").update({content:e.new_content||a.content,metadata:i}).eq("id",a.id),s="Item da lista atualizado com sucesso."}}}}else if(h==="manage_items"){if(e.metadata){if(e.metadata.password||e.metadata.username)throw new Error("FORBIDDEN: You are trying to save CREDENTIALS using the generic 'manage_items' tool. You MUST use 'manage_credentials' for security.");if(e.metadata.amount)throw new Error("FORBIDDEN: You are trying to save FINANCIAL data using 'manage_items'. You MUST use 'manage_financials' to ensure correct calculations.")}if(e.items&&Array.isArray(e.items))for(const t of e.items){if(t.metadata?.password||t.metadata?.username)throw new Error("FORBIDDEN: You are trying to save CREDENTIALS using 'manage_items'. Use 'manage_credentials'.");if(t.metadata?.amount)throw new Error("FORBIDDEN: You are trying to save FINANCIAL data using 'manage_items'. Use 'manage_financials'.")}const{data:n}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(n){if(e.action==="list"){const{data:t}=await r.from("collection_items").select("*").eq("collection_id",n.id).order("created_at",{ascending:!1}).limit(20);s=`Itens na pasta "${e.collection_name}":
${t?.map(o=>`- ${o.content} (${JSON.stringify(o.metadata)})`).join(`
`)||"Vazia"}`}else if(e.action==="add")if(e.items&&Array.isArray(e.items)&&e.items.length>0){console.log(`\u{1F680} BATCH ADD: ${e.items.length} items to ${e.collection_name}`);const t=e.items.map(a=>({collection_id:n.id,user_id:c,type:a.metadata?.type||"text",content:a.content||"Item sem nome",media_url:null,metadata:a.metadata?{...a.metadata,amount:a.metadata.amount?Number(a.metadata.amount):void 0}:null})),{error:o}=await r.from("collection_items").insert(t);o?(console.error("\u274C Error in batch insert:",o),s=`Erro ao adicionar itens em lote: ${o.message}`):s=`${e.items.length} itens adicionados com sucesso na pasta "${e.collection_name}".`}else{const{error:t}=await r.from("collection_items").insert({collection_id:n.id,user_id:c,type:e.type||"text",content:e.content||null,media_url:e.media_url||d||null,metadata:e.metadata?{...e.metadata,amount:e.metadata.amount?Number(e.metadata.amount):void 0}:null});t?(console.error("\u274C Error inserting item into EXISTING collection:",t),s=`Erro ao salvar item: ${t.message} `):(console.log(`\u2705 Item inserted into EXISTING collection ${n.id} `),s=`Item adicionado na pasta "${e.collection_name}".`)}else if(e.action==="update"||e.action==="delete"){let t=r.from("collection_items").select("id, content, metadata").eq("collection_id",n.id);const o=e.search_content||e.content;o&&(t=t.ilike("content",`%${o}%`)),e.search_metadata_key&&e.search_metadata_value&&(t=t.eq(`metadata ->> ${e.search_metadata_key} `,e.search_metadata_value));const{data:a}=await t.limit(5);let i=null;if(!a||a.length===0)s=`Erro: N\xE3o encontrei nenhum item correspondente na pasta "${e.collection_name}".`;else if(a.length>1){const l=a.map(w=>`- ${w.content} (ID: ${w.id})`).join(`
`);s=`Encontrei m\xFAltiplos itens parecidos. Qual deles voc\xEA quer ${e.action==="delete"?"apagar":"alterar"}?
${l}

Por favor, seja mais espec\xEDfico.`}else if(i=a[0],e.action==="delete")await r.from("collection_items").delete().eq("id",i.id),s=`Item apagado da pasta "${e.collection_name}".`;else{let l=e.content||i.content;e.should_append&&e.content&&(l=`${i.content}
${e.content}`),await r.from("collection_items").update({content:l,metadata:e.metadata?{...i.metadata,...e.metadata,amount:e.metadata.amount?Number(e.metadata.amount):i.metadata?.amount||void 0}:i.metadata}).eq("id",i.id),s=`Item atualizado na pasta "${e.collection_name}".`}}}else{const{data:t,error:o}=await r.from("collections").insert({user_id:c,name:e.collection_name,icon:"\u{1F4C1}"}).select().single();if(o||!t)s=`Erro: N\xE3o foi poss\xEDvel criar a pasta "${e.collection_name}".`;else if(e.items&&Array.isArray(e.items)&&e.items.length>0){const a=e.items.map(l=>({collection_id:t.id,user_id:c,type:l.metadata?.type||"text",content:l.content||"Item sem nome",media_url:null,metadata:l.metadata?{...l.metadata,amount:l.metadata.amount?Number(l.metadata.amount):void 0}:null})),{error:i}=await r.from("collection_items").insert(a);i?s=`Pasta criada, mas erro ao adicionar itens: ${i.message}`:s=`Pasta "${e.collection_name}" criada e ${e.items.length} itens adicionados.`}else{const{error:a}=await r.from("collection_items").insert({collection_id:t.id,user_id:c,type:e.type||"text",content:e.content||null,media_url:e.media_url||d||null,metadata:e.metadata?{...e.metadata,amount:e.metadata.amount?Number(e.metadata.amount):void 0}:null});a?(console.error("\u274C Error inserting item into NEW collection:",a),s=`Erro ao salvar item na nova pasta: ${a.message} `):(console.log(`\u2705 Item inserted into NEW collection ${t.id} `),s=`Pasta "${e.collection_name}" criada automaticamente e item adicionado com sucesso.`)}}}else if(h==="manage_monitors"){if(e.action==="create")if(!e.keyword)s="Erro: 'keyword' \xE9 obrigat\xF3rio para criar um monitor.";else{const{error:n}=await r.from("monitors").insert({user_id:c,keyword:e.keyword,chat_name:e.chat_name||null,frequency:e.frequency||"ask"});n?s=`Erro ao criar monitor: ${n.message}`:s=`Monitor criado! Vou te avisar se encontrar "${e.keyword}" ${e.chat_name?`em "${e.chat_name}"`:"em qualquer conversa"}.`}else if(e.action==="list"){const{data:n}=await r.from("monitors").select("*").eq("user_id",c).eq("is_active",!0);!n||n.length===0?s="Nenhum monitor ativo no momento.":s=`Monitores Ativos:
`+n.map(t=>`- "${t.keyword}" (${t.chat_name||"Todos"}) [${t.frequency}]`).join(`
`)}else if(e.action==="delete"){const{error:n}=await r.from("monitors").delete().eq("user_id",c).ilike("keyword",`%${e.keyword}%`);n?s=`Erro ao apagar monitor: ${n.message}`:s="Monitor removido."}}else if(h==="manage_rules"){if(console.log("rules manager called",e),e.action==="create")if(!e.key||!e.value)s="Erro: 'key' e 'value' s\xE3o obrigat\xF3rios para criar uma regra.";else{const{error:n}=await r.from("user_preferences").insert({user_id:c,key:e.key,value:e.value});n?(console.error("Error creating rule:",n),s=`Erro ao criar regra: ${n.message}`):s=`Regra criada: [${e.key}] ${e.value}`}else if(e.action==="delete")if(!e.id&&!e.key)s="Erro: Forne\xE7a o ID da regra ou o 'key' para deletar.";else{let n=r.from("user_preferences").delete().eq("user_id",c);e.id?n=n.eq("id",e.id):e.key&&(n=n.eq("key",e.key));const{error:t}=await n;t?(console.error("Error deleting rule:",t),s=`Erro ao deletar regra: ${t.message}`):s="Regra(s) removida(s) com sucesso."}else if(e.action==="list"){const{data:n}=await r.from("user_preferences").select("*").eq("user_id",c);n&&n.length>0?s=`Regras Atuais:
`+n.map(t=>`ID: ${t.id} | [${t.key}]: ${t.value}`).join(`
`):s="Nenhuma regra definida."}}else if(h==="get_unread_conversations"){const n=e.limit||20,t=e.offset||0,o=Deno.env.get("ENCRYPTION_KEY");if(!o)console.error("\u274C CRITICAL: ENCRYPTION_KEY not set. Cannot decrypt unread conversations."),s="Erro: Chave de criptografia n\xE3o configurada. N\xE3o consigo ler as mensagens.";else{const{data:a,error:i}=await r.rpc("get_unread_conversations",{p_user_id:c,p_limit:n,p_offset:t,p_encryption_key:o});i?(console.error("Error fetching unread conversations:",i),s=`Erro ao buscar conversas n\xE3o lidas: ${i.message}`):!a||a.length===0?s="Nenhuma conversa n\xE3o lida encontrada.":s=`Conversas n\xE3o lidas:
`+a.map(l=>{const w=l.group_name||l.sender_name||l.sender_number,L=l.is_group?"[Grupo]":"[Privado]",j=new Date(l.last_message_at).toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"});return`- ${L} ${w}: "${l.last_message_content?.substring(0,50)}..." (${j})`}).join(`
`)}}else if(h==="manage_emails"){console.log("\u{1F4E7} Managing Emails:",e);const n=e.provider||"all",t=n==="all"?["google","microsoft"]:[n],{data:o}=await r.from("user_integrations").select("*").eq("user_id",c).in("provider",t);if(!o||o.length===0)s="Nenhuma conta de email conectada para o provedor solicitado. Por favor, conecte suas contas nas configura\xE7\xF5es.";else{const a=[];for(const i of o)try{let l=i.access_token;const w=new Date(i.expires_at),L=new Date,j=i.provider==="google",G=i.provider==="microsoft";if(w.getTime()-L.getTime()<300*1e3){console.log(`\u{1F504} Refreshing ${i.provider} Token...`);let f="",u={};j?(f="https://oauth2.googleapis.com/token",u={client_id:Deno.env.get("GOOGLE_CLIENT_ID"),client_secret:Deno.env.get("GOOGLE_CLIENT_SECRET"),refresh_token:i.refresh_token,grant_type:"refresh_token"}):G&&(f="https://login.microsoftonline.com/common/oauth2/v2.0/token",u={client_id:Deno.env.get("MICROSOFT_CLIENT_ID"),client_secret:Deno.env.get("MICROSOFT_CLIENT_SECRET"),refresh_token:i.refresh_token,grant_type:"refresh_token"});const E=await(await fetch(f,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(u)})).json();if(E.error)throw new Error(E.error_description||E.error);l=E.access_token;const y=new Date(Date.now()+E.expires_in*1e3).toISOString();await r.from("user_integrations").update({access_token:l,expires_at:y,updated_at:new Date().toISOString()}).eq("id",i.id)}const N={Authorization:`Bearer ${l}`,"Content-Type":"application/json"};if(j){const f="https://gmail.googleapis.com/gmail/v1/users/me";if(e.action==="list"){const u=e.query||"is:inbox",E=await(await fetch(`${f}/messages?q=${encodeURIComponent(u)}&maxResults=${e.limit||5}`,{headers:N})).json();if(E.messages)for(const y of E.messages){const R=await(await fetch(`${f}/messages/${y.id}?format=metadata&metadataHeaders=From&metadataHeaders=Subject&metadataHeaders=Date`,{headers:N})).json(),ae=R.payload.headers.find(Y=>Y.name==="Subject")?.value||"(Sem Assunto)",P=R.payload.headers.find(Y=>Y.name==="From")?.value||"Desconhecido",Z=R.payload.headers.find(Y=>Y.name==="Date")?.value||"";a.push(`[GMAIL] ID: ${y.id} | ${Z} | De: ${P} | ${ae}`)}}else if(e.action==="read"){const u=await fetch(`${f}/messages/${e.email_id}?format=full`,{headers:N});if(u.ok){const _=await u.json();let y=_.snippet;const A=P=>{try{return atob(P.replace(/-/g,"+").replace(/_/g,"/"))}catch{return"(Erro decode)"}};if(_.payload.body?.data)y=A(_.payload.body.data);else if(_.payload.parts){const P=_.payload.parts.find(Z=>Z.mimeType==="text/plain");P?.body?.data&&(y=A(P.body.data))}const R=_.payload.headers.find(P=>P.name==="Subject")?.value,ae=_.payload.headers.find(P=>P.name==="From")?.value;a.push(`[GMAIL] De: ${ae}
Assunto: ${R}
Corpo: ${y}`)}}else if(e.action==="send"||e.action==="reply"){const _=[`To: ${e.to}`,`Subject: ${e.subject}`,'Content-Type: text/plain; charset="UTF-8"',"MIME-Version: 1.0","",e.body].join(`
`),E=btoa(unescape(encodeURIComponent(_))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),y=await fetch(`${f}/messages/send`,{method:"POST",headers:N,body:JSON.stringify({raw:E})});y.ok?a.push("[GMAIL] Enviado com sucesso."):a.push(`[GMAIL] Erro ao enviar: ${(await y.json()).error.message}`)}else e.action==="move_to_trash"&&(await fetch(`${f}/messages/${e.email_id}/trash`,{method:"POST",headers:N}),a.push("[GMAIL] Movido para lixeira."))}else if(G){const f="https://graph.microsoft.com/v1.0/me";if(e.action==="list"){const _=await(await fetch(`${f}/messages?$top=${e.limit||5}&$select=id,subject,from,receivedDateTime,bodyPreview&$orderby=receivedDateTime desc`,{headers:N})).json();if(_.value)for(const E of _.value)a.push(`[OUTLOOK] ID: ${E.id} | ${E.receivedDateTime} | De: ${E.from.emailAddress.name} <${E.from.emailAddress.address}> | ${E.subject}`)}else if(e.action==="read"){const u=await fetch(`${f}/messages/${e.email_id}?$select=subject,from,toRecipients,receivedDateTime,body`,{headers:N});if(u.ok){const _=await u.json(),E=_.body.content.replace(/<[^>]*>?/gm,"");a.push(`[OUTLOOK] De: ${_.from.emailAddress.name}
Assunto: ${_.subject}
Corpo: ${E}`)}}else if(e.action==="send"||e.action==="reply"){const u={message:{subject:e.subject,body:{contentType:"Text",content:e.body},toRecipients:[{emailAddress:{address:e.to}}]},saveToSentItems:"true"},_=await fetch(`${f}/sendMail`,{method:"POST",headers:N,body:JSON.stringify(u)});_.ok?a.push("[OUTLOOK] Enviado com sucesso."):a.push(`[OUTLOOK] Erro ao enviar: ${await _.text()}`)}else if(e.action==="move_to_trash"){const u=await fetch(`${f}/messages/${e.email_id}`,{method:"DELETE",headers:N});u.ok?a.push("[OUTLOOK] Movido para lixeira."):a.push(`[OUTLOOK] Erro ao apagar: ${await u.text()}`)}}}catch(l){console.error(`Error processing ${i.provider}:`,l),a.push(`[${i.provider.toUpperCase()}] Erro: ${l.message}`)}s=a.length>0?a.join(`

`):"Nenhum resultado encontrado."}}else if(h==="manage_users"){if(!M?.is_admin)throw new Error("\u26D4 ACESSO NEGADO: Apenas administradores podem usar esta ferramenta.");if(console.log("\u{1F6E1}\uFE0F ADMIN ACTION:",e),e.action==="list"){const{data:n,error:t}=await r.from("user_settings").select("user_id, preferred_name, ai_model, is_admin");if(t)throw t;s=`\u{1F465} Lista de Usu\xE1rios:
${n.map(a=>`- ${a.preferred_name||"Sem Nome"} (ID: ${a.user_id}) [Model: ${a.ai_model}] ${a.is_admin?"\u{1F6E1}\uFE0F ADMIN":""}`).join(`
`)}`}else if(e.action==="update_model"){if(!e.target_user_id||!e.model)throw new Error("target_user_id e model s\xE3o obrigat\xF3rios.");const{error:n}=await r.from("user_settings").update({ai_model:e.model}).eq("user_id",e.target_user_id);if(n)throw n;s=`\u2705 Modelo do usu\xE1rio ${e.target_user_id} atualizado para ${e.model}.`}else if(e.action==="delete"){if(!e.target_user_id)throw new Error("target_user_id \xE9 obrigat\xF3rio.");const{error:n}=await r.from("user_settings").delete().eq("user_id",e.target_user_id);if(n)throw n;s=`\u26A0\uFE0F Configura\xE7\xF5es do usu\xE1rio ${e.target_user_id} apagadas. (A conta Auth ainda existe).`}}else if(h==="manage_calendar"){console.log("\u{1F4C5} Managing Calendar:",e);const n=e.provider||"all",t=n==="all"?["google","microsoft"]:[n],{data:o}=await r.from("user_integrations").select("*").eq("user_id",c).in("provider",t);if(!o||o.length===0)s="Nenhuma conta de calend\xE1rio conectada. Por favor, conecte Google ou Outlook nas configura\xE7\xF5es.";else{const a=[];for(const i of o)try{let l=i.access_token;const w=new Date(i.expires_at),L=new Date,j=i.provider==="google",G=i.provider==="microsoft";if(w.getTime()-L.getTime()<300*1e3){console.log(`\u{1F504} Refreshing ${i.provider} Token...`);let f="",u={};j?(f="https://oauth2.googleapis.com/token",u={client_id:Deno.env.get("GOOGLE_CLIENT_ID"),client_secret:Deno.env.get("GOOGLE_CLIENT_SECRET"),refresh_token:i.refresh_token,grant_type:"refresh_token"}):G&&(f="https://login.microsoftonline.com/common/oauth2/v2.0/token",u={client_id:Deno.env.get("MICROSOFT_CLIENT_ID"),client_secret:Deno.env.get("MICROSOFT_CLIENT_SECRET"),refresh_token:i.refresh_token,grant_type:"refresh_token"});const E=await(await fetch(f,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(u)})).json();if(E.error)throw new Error(E.error_description||E.error);l=E.access_token;const y=new Date(Date.now()+E.expires_in*1e3).toISOString();await r.from("user_integrations").update({access_token:l,expires_at:y,updated_at:new Date().toISOString()}).eq("id",i.id)}const N={Authorization:`Bearer ${l}`,"Content-Type":"application/json"};if(e.action==="list_events"){const f=e.start_date||new Date().toISOString(),u=e.end_date||new Date(Date.now()+10080*60*1e3).toISOString();if(j){const _=`https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${f}&timeMax=${u}&singleEvents=true&orderBy=startTime`,y=await(await fetch(_,{headers:N})).json();y.items&&a.push(...y.items.map(A=>`[GOOGLE] ${A.start.dateTime?new Date(A.start.dateTime).toLocaleString("pt-BR"):`${A.start.date} (Dia todo)`} - ${A.summary} (ID: ${A.id})`))}else if(G){const _=`https://graph.microsoft.com/v1.0/me/calendarView?startDateTime=${f}&endDateTime=${u}&$top=20&$select=id,subject,start,end,isAllDay`,y=await(await fetch(_,{headers:N})).json();y.value&&a.push(...y.value.map(A=>`[OUTLOOK] ${A.isAllDay?`${A.start.dateTime.split("T")[0]} (Dia todo)`:new Date(A.start.dateTime).toLocaleString("pt-BR")} - ${A.subject} (ID: ${A.id})`))}}else if(e.action==="create_event"){const f=e.start_time;let u=e.end_time;if(!u&&f){const _=new Date(f);_.setHours(_.getHours()+1),u=_.toISOString()}if(j){const _={summary:e.title,description:e.description,start:e.all_day?{date:f.split("T")[0]}:{dateTime:f},end:e.all_day?{date:u.split("T")[0]}:{dateTime:u},location:e.location},y=await(await fetch("https://www.googleapis.com/calendar/v3/calendars/primary/events",{method:"POST",headers:N,body:JSON.stringify(_)})).json();y.id?a.push(`[GOOGLE] Evento criado: "${e.title}" em ${new Date(f).toLocaleString("pt-BR")}`):a.push(`[GOOGLE] Erro ao criar: ${JSON.stringify(y)}`)}else if(G){const _={subject:e.title,body:{contentType:"Text",content:e.description||""},start:{dateTime:f,timeZone:"America/Sao_Paulo"},end:{dateTime:u,timeZone:"America/Sao_Paulo"},location:{displayName:e.location},isAllDay:e.all_day},y=await(await fetch("https://graph.microsoft.com/v1.0/me/events",{method:"POST",headers:N,body:JSON.stringify(_)})).json();y.id?a.push(`[OUTLOOK] Evento criado: "${e.title}" em ${new Date(f).toLocaleString("pt-BR")}`):a.push(`[OUTLOOK] Erro ao criar: ${JSON.stringify(y)}`)}}else if(e.action==="delete_event"){let f=e.event_id;if(!f&&e.title){if(j){const u=`https://www.googleapis.com/calendar/v3/calendars/primary/events?q=${encodeURIComponent(e.title)}&timeMin=${new Date().toISOString()}&maxResults=5`,y=(await(await fetch(u,{headers:N})).json()).items||[];if(y.length===0)a.push(`[GOOGLE] N\xE3o encontrei nenhum evento futuro com o t\xEDtulo "${e.title}".`);else if(y.length>1){const A=y.map(R=>`- ${R.summary} (${new Date(R.start.dateTime||R.start.date).toLocaleString("pt-BR")}) [ID: ${R.id}]`).join(`
`);a.push(`[GOOGLE] Encontrei m\xFAltiplos eventos. Qual deles apagar?
${A}`)}else f=y[0].id}else if(G){const u=`https://graph.microsoft.com/v1.0/me/events?$filter=contains(subject,'${e.title}') and start/dateTime ge '${new Date().toISOString()}'&$top=5`,y=(await(await fetch(u,{headers:N})).json()).value||[];if(y.length===0)a.push(`[OUTLOOK] N\xE3o encontrei nenhum evento futuro com o t\xEDtulo "${e.title}".`);else if(y.length>1){const A=y.map(R=>`- ${R.subject} (${new Date(R.start.dateTime).toLocaleString("pt-BR")}) [ID: ${R.id}]`).join(`
`);a.push(`[OUTLOOK] Encontrei m\xFAltiplos eventos. Qual deles apagar?
${A}`)}else f=y[0].id}}if(!f&&!e.title)a.push("Erro: ID do evento ou T\xEDtulo necess\xE1rio para deletar.");else if(f){if(j){const u=await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${f}`,{method:"DELETE",headers:N});u.ok?a.push("[GOOGLE] Evento apagado com sucesso."):a.push(`[GOOGLE] Erro ao apagar: ${(await u.json()).error?.message}`)}else if(G){const u=await fetch(`https://graph.microsoft.com/v1.0/me/events/${f}`,{method:"DELETE",headers:N});u.ok?a.push("[OUTLOOK] Evento apagado com sucesso."):a.push(`[OUTLOOK] Erro ao apagar: ${await u.text()}`)}}}}catch(l){console.error(`Error processing Calendar ${i.provider}:`,l),a.push(`[${i.provider.toUpperCase()}] Erro: ${l.message}`)}s=a.length>0?a.join(`
`):"Nenhum evento encontrado ou a\xE7\xE3o realizada."}}else if(h==="search_contacts"){const{data:n}=await r.from("messages").select("sender_name, sender_number, created_at").eq("user_id",c).or(`sender_name.ilike.%${e.query}%,sender_number.ilike.%${e.query}%`).order("created_at",{ascending:!1}).limit(50);if(!n||n.length===0)s=`Nenhum contato encontrado com o nome "${e.query}". Tente buscar por parte do nome.`;else{const t=new Map;n.forEach(i=>{t.has(i.sender_number)||t.set(i.sender_number,{name:i.sender_name,number:i.sender_number,last_seen:i.created_at})});const a=Array.from(t.values()).sort((i,l)=>{const w=i.number.startsWith("55")&&i.number.length>=12&&i.number.length<=13,L=l.number.startsWith("55")&&l.number.length>=12&&l.number.length<=13;return w&&!L?-1:!w&&L?1:new Date(l.last_seen).getTime()-new Date(i.last_seen).getTime()}).map(i=>{const w=i.number.startsWith("55")&&i.number.length>=12&&i.number.length<=13?"[\u{1F4F1} CELULAR]":"[\u2753 OUTRO/ID]";return`- ${i.name} (${i.number}) ${w} [Visto em: ${new Date(i.last_seen).toLocaleDateString("pt-BR")}]`}).join(`
`);s=`Contatos encontrados para "${e.query}":
${a}

PREFIRA N\xDAMEROS MARCADOS COMO [\u{1F4F1} CELULAR]. Evite [\u2753 OUTRO/ID] se poss\xEDvel.`}}else if(h==="query_data"){const{data:n}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!n)s=`Pasta "${e.collection_name}" n\xE3o encontrada.`;else{e.start_date;const{data:t}=await r.from("collection_items").select("*").eq("collection_id",n.id).order("created_at",{ascending:!1}).limit(500);let o=t||[];if(e.start_date&&(o=o.filter(a=>(a.metadata?.date||a.created_at)>=e.start_date)),e.end_date&&(o=o.filter(a=>(a.metadata?.date||a.created_at)<=e.end_date)),e.filter_key&&e.filter_value&&(o=o.filter(a=>a.metadata?.[e.filter_key]===e.filter_value)),!o||o.length===0)s=`Nenhum dado encontrado com esses filtros em "${e.collection_name}".`;else if(e.operation==="sum"&&e.field){const a=o.reduce((l,w)=>l+(Number(w.metadata?.[e.field])||0),0),i=o.map(l=>`- ${l.content||""} (Meta: ${JSON.stringify(l.metadata||{})})`).join(`
`);s=`Total (via metadata '${e.field}'): ${a}.

Itens considerados:
${i}

(Se o total for 0, verifique os itens acima para somar manualmente)`}else if(e.operation==="count")s=`Total de itens: ${o.length} `;else if(e.operation==="average"&&e.field){const a=o.reduce((l,w)=>l+(Number(w.metadata?.[e.field])||0),0),i=o.map(l=>`- ${l.content||""} (Meta: ${JSON.stringify(l.metadata||{})})`).join(`
`);s=`M\xE9dia (via metadata '${e.field}'): ${(a/o.length).toFixed(2)}.

Itens considerados:
${i}`}else s=`Resultado: 
${o.map(i=>{const l=i.metadata?JSON.stringify(i.metadata):"";return`- ${i.content||""} ${l} `}).join(`
`)} `}}else if(h==="global_search")s=await Ee(r,c,e);else if(h==="manage_reminders"){if(e.action==="create"){const n=ee(e,U,V);if(n){const t=new Date(n),o=new Date,a=(t.getTime()-o.getTime())/(1e3*60);if(console.log(`\u{1F50D} DATE CHECK: Due = ${n}, Diff = ${a.toFixed(1)} min`),a<-5)s=`ERRO: A data calculada(${n}) est\xE1 no passado.Por favor, seja mais espec\xEDfico(ex: "amanh\xE3 \xE0s 10h").`,console.error("\u274C REJECTED: Date in past");else{const i={user_id:c,title:e.title,due_at:n,recurrence_type:e.recurrence_type||"once",is_completed:!1};e.recurrence_type&&e.recurrence_type!=="once"&&(e.recurrence_type==="custom"&&(i.recurrence_interval=e.recurrence_interval,i.recurrence_unit=e.recurrence_unit),e.recurrence_type==="weekly"&&e.weekdays&&(i.weekdays=e.weekdays),e.recurrence_count&&(i.recurrence_count=e.recurrence_count));const{error:l}=await r.from("reminders").insert(i);if(l)throw l;let w=`Lembrete "${e.title}" agendado para ${n} `;e.recurrence_type!=="once"&&(w+=` (Recorrente: ${e.recurrence_type})`),s=w}}else s="Erro: N\xE3o foi poss\xEDvel calcular a data do lembrete. Tente novamente."}else if(e.action==="list"){const{data:n}=await r.from("reminders").select("*").eq("user_id",c).eq("is_completed",!1).order("due_at");s=`Lembretes pendentes: ${n?.map(t=>`[ID: ${t.id}] ${t.title} (${t.due_at})`).join(", ")||"Nenhum"} `}else if(e.action==="complete")if(e.id)await r.from("reminders").update({is_completed:!0}).eq("id",e.id).eq("user_id",c),s=`Lembrete marcado como conclu\xEDdo (ID: ${e.id}).`;else{const n=e.search_title||e.title,{data:t}=await r.from("reminders").select("id, title, due_at").eq("user_id",c).eq("is_completed",!1).ilike("title",`%${n}%`);if(t&&t.length===1)await r.from("reminders").update({is_completed:!0}).eq("id",t[0].id),s=`Lembrete "${t[0].title}" marcado como conclu\xEDdo.`;else if(t&&t.length>1)s=`Encontrei m\xFAltiplos lembretes pendentes com esse nome. Qual deles voc\xEA quer concluir?
${t.map(a=>`- ${a.title} (${new Date(a.due_at).toLocaleString("pt-BR")}) [ID: ${a.id}]`).join(`
`)}

Por favor, repita o comando usando o ID ou o nome mais espec\xEDfico.`;else{const{data:o}=await r.from("reminders").select("id, title").eq("user_id",c).eq("is_completed",!0).ilike("title",`%${n}%`).limit(1);o&&o.length>0?s=`O lembrete "${o[0].title}" j\xE1 estava conclu\xEDdo.`:s=`N\xE3o encontrei nenhum lembrete chamado "${n}".`}}else if(e.action==="update"){let n=null;if(e.id){const{data:t}=await r.from("reminders").select("*").eq("id",e.id).eq("user_id",c).single();n=t}else{const t=e.title,{data:o}=await r.from("reminders").select("*").eq("user_id",c).eq("is_completed",!1).ilike("title",`%${t}%`).limit(5);if(o&&o.length===1)n=o[0];else if(o&&o.length>1)s=`Encontrei m\xFAltiplos lembretes pendentes. Qual deles alterar?
${o.map(i=>`- ${i.title} (${new Date(i.due_at).toLocaleString("pt-BR")}) [ID: ${i.id}]`).join(`
`)}`;else{const{data:a}=await r.from("reminders").select("*").eq("user_id",c).ilike("title",`%${t}%`).limit(1);n=a?.[0]}}if(!n&&!s)s="Erro: Lembrete n\xE3o encontrado para atualiza\xE7\xE3o.";else if(n){const t={};if(e.title&&(t.title=e.title),e.time_config||e.relative_time||V){const a=ee(e,U,V);a&&(t.due_at=a)}e.recurrence_type&&(t.recurrence_type=e.recurrence_type),e.recurrence_interval&&(t.recurrence_interval=e.recurrence_interval),e.recurrence_unit&&(t.recurrence_unit=e.recurrence_unit),e.weekdays&&(t.weekdays=e.weekdays),e.recurrence_count&&(t.recurrence_count=e.recurrence_count);const{error:o}=await r.from("reminders").update(t).eq("id",n.id);if(o)throw o;s="Lembrete atualizado com sucesso."}}else if(e.action==="delete"){let n=null;if(e.id)n={id:e.id};else{const t=e.search_title||e.title,{data:o}=await r.from("reminders").select("id, title, due_at").eq("user_id",c).eq("is_completed",!1).ilike("title",`%${t}%`).limit(5);if(o&&o.length===1)n=o[0];else if(o&&o.length>1)s=`Encontrei m\xFAltiplos lembretes pendentes. Qual deles apagar?
${o.map(i=>`- ${i.title} (${new Date(i.due_at).toLocaleString("pt-BR")}) [ID: ${i.id}]`).join(`
`)}`;else{const{data:a}=await r.from("reminders").select("id, title").eq("user_id",c).ilike("title",`%${t}%`).limit(1);n=a?.[0]}}!n&&!s?s="Erro: Lembrete n\xE3o encontrado para apagar.":n&&(await r.from("reminders").delete().eq("id",n.id).eq("user_id",c),s=`Lembrete apagado (ID: ${n.id}).`)}}else if(h==="manage_tasks"){if(e.action==="create"){const n=ee(e,U,null),{error:t}=await r.from("tasks").insert({user_id:c,title:e.title,description:e.description||null,priority:e.priority||"medium",status:e.status||"todo",tags:e.tags||[],due_date:n});if(t)throw t;const o=n?` para ${new Date(n).toLocaleDateString("pt-BR")}`:"";s=`Tarefa "${e.title}" adicionada \xE0 lista${o}.`}else if(e.action==="list"){let n=r.from("tasks").select("*").eq("user_id",c);e.filter_status?n=n.eq("status",e.filter_status):n=n.neq("status","done").neq("status","archived");const{data:t}=await n.order("created_at",{ascending:!1});if(!t||t.length===0)s="Nenhuma tarefa encontrada.";else{let o=t;if(e.filter_date==="today"){const a=U.toISOString().split("T")[0];o=t.filter(i=>{if(!i.due_date)return!1;const l=i.due_date.split("T")[0];return l===a||l<a&&i.status!=="done"})}else if(e.filter_date==="tomorrow"){const a=new Date(U);a.setDate(a.getDate()+1);const i=a.toISOString().split("T")[0];o=t.filter(l=>l.due_date&&l.due_date.startsWith(i))}o.length===0?s=`Nenhuma tarefa encontrada para "${e.filter_date||"filtro atual"}".`:s=`Suas Tarefas:
${o.map(a=>{const i=a.due_date?` [\u{1F4C5} ${new Date(a.due_date).toLocaleDateString("pt-BR")}]`:"";return`- [${a.status.toUpperCase()}] ${a.title} (${a.priority})${i}`}).join(`
`)}`}}else if(e.action==="update"||e.action==="complete"||e.action==="delete"){let n=r.from("tasks").select("id, title, status").eq("user_id",c);e.action==="complete"||e.action,e.search_title&&(n=n.ilike("title",`%${e.search_title}%`));const{data:t}=await n.limit(5);let o=null;if(t&&t.length>0&&(e.action==="complete"&&(o=t.find(a=>a.status!=="done"&&a.status!=="archived")),o||(o=t[0])),!o)s=`Erro: Tarefa "${e.search_title}" n\xE3o encontrada.`;else if(e.action==="complete"&&o.status==="done")s=`A tarefa "${o.title}" j\xE1 estava conclu\xEDda!`;else if(e.action==="delete")await r.from("tasks").delete().eq("id",o.id),s=`Tarefa "${o.title}" apagada.`;else if(e.action==="complete")await r.from("tasks").update({status:"done",completed_at:new Date().toISOString()}).eq("id",o.id),s=`Tarefa "${o.title}" marcada como conclu\xEDda! \u{1F389}`;else{const a={};if(e.title&&(a.title=e.title),e.description&&(a.description=e.description),e.priority&&(a.priority=e.priority),e.status&&(a.status=e.status),e.tags&&(a.tags=e.tags),e.due_date||e.time_config||e.relative_time){const i=ee(e,U,null);i&&(a.due_date=i)}await r.from("tasks").update(a).eq("id",o.id),s=`Tarefa "${o.title}" atualizada.`}}}else if(h==="save_memory"){console.log(`\u{1F9E0} Saving memory: "${e.content}"`);const t=await(await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},body:JSON.stringify({model:"text-embedding-3-small",input:e.content})})).json(),o=t.data?.[0]?.embedding;if(!o)console.error("\u274C OpenAI Embedding Error:",JSON.stringify(t)),s=`Erro ao gerar vetor: ${JSON.stringify(t)}`;else{const{error:a}=await r.from("memories").insert({user_id:c,content:e.content,embedding:o,metadata:{category:e.category||"general"}});if(a)throw a;s="Mem\xF3ria salva com sucesso! \u{1F9E0}"}}else if(h==="recall_memory"){console.log(`\u{1F9E0} Recalling memory for: "${e.query}"`);const o=(await(await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},body:JSON.stringify({model:"text-embedding-3-small",input:e.query})})).json()).data?.[0]?.embedding;if(!o)s="Erro ao gerar vetor de busca.";else{const{data:a,error:i}=await r.rpc("match_memories",{query_embedding:o,match_threshold:.5,match_count:e.match_count||5,p_user_id:c});i?(console.error("\u274C Match Error:",i),s="Erro ao buscar mem\xF3rias."):!a||a.length===0?s="Nenhuma mem\xF3ria relevante encontrada.":s=`Mem\xF3rias Encontradas:
${a.map(w=>`- ${w.content} (Similaridade: ${(w.similarity*100).toFixed(0)}%)`).join(`
`)}`}}else if(h==="send_whatsapp_message"){if(M?.privacy_allow_outgoing===!1)throw console.warn("\u{1F6D1} BLOCKED OUTGOING MESSAGE: User disabled outgoing messages."),new Error("\u26D4 A\xE7\xE3o Bloqueada: Voc\xEA configurou sua privacidade para N\xC3O permitir que a IA envie mensagens para outras pessoas.");console.log(`\u{1F4E4} Sending WhatsApp message to ${e.number}`);const n=e.number.replace(/\D/g,""),t=n.includes("@")?n:`${n}@s.whatsapp.net`,o=Deno.env.get("EVOLUTION_API_URL"),a=Deno.env.get("EVOLUTION_API_KEY"),{data:i}=await r.from("whatsapp_instances").select("instance_name").eq("user_id",c).eq("status","connected").limit(1),l=i?.[0]?.instance_name||"user_personal";console.log(`\u{1F4E4} Sending WhatsApp message to ${t} via ${l}`);let w;e.media_url?(console.log(`\u{1F4CE} Sending Media: ${e.media_url}`),w=await fetch(`${o}/message/sendMedia/${l}`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a},body:JSON.stringify({number:t,options:{delay:1200},mediaMessage:{mediatype:e.media_type||"image",media:e.media_url,caption:e.message||""}})})):w=await fetch(`${o}/message/sendText/${l}`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a},body:JSON.stringify({number:t,options:{delay:1200},text:e.message})});const L=await w.text();w.ok?(console.log("\u2705 Outgoing message sent!"),await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:"Outgoing WhatsApp message sent",meta:{number:t,instance:l,hasMedia:!!e.media_url}}),s=`Mensagem enviada com sucesso para ${e.number}.`):(console.error("\u274C Failed to send outgoing message:",L),await r.from("debug_logs").insert({function_name:"process-message",level:"error",message:"Failed to send WhatsApp message",meta:{error:L,number:t,instance:l}}),s=`Erro ao enviar mensagem: ${L}`)}else if(h==="query_messages"){const n=e.limit||20,t=e.days_ago||7,o=Deno.env.get("ENCRYPTION_KEY");if(!o)console.error("\u274C CRITICAL: ENCRYPTION_KEY not set. Cannot decrypt messages."),s="Erro: Chave de criptografia n\xE3o configurada. N\xE3o consigo ler o hist\xF3rico.";else{const{data:a,error:i}=await r.rpc("get_messages_decrypted",{p_encryption_key:o,p_limit:n,p_offset:0,p_user_id:c,p_sender_number:e.sender_number||null,p_group_name:e.group_name||null,p_days_ago:t});i?(console.error("\u274C Error fetching decrypted messages:",i),s=`Erro ao buscar mensagens: ${i.message}`):!a||a.length===0?s="Nenhuma mensagem encontrada com esses crit\xE9rios.":s=a.map(l=>`[${new Date(l.created_at).toLocaleString("pt-BR")}] ${l.sender_name||l.sender_number}: ${l.content} ${l.media_type?`[${l.media_type}]`:""}`).reverse().join(`
`)}}else if(h==="migrate_legacy_collections")s=await Oe(r,c,e);else if(h==="update_user_settings"){const{preferred_name:n,daily_briefing_enabled:t,daily_briefing_time:o,daily_briefing_prompt:a,ai_name:i}=e,l={};if(n&&(l.preferred_name=n),t!==void 0&&(l.daily_briefing_enabled=t),o&&(l.daily_briefing_time=o),e.daily_briefing_prompt!==void 0&&(l.daily_briefing_prompt=e.daily_briefing_prompt),e.ai_name!==void 0&&(l.ai_name=e.ai_name),Object.keys(l).length>0){const{error:w}=await r.from("user_settings").update(l).eq("user_id",c);w?(console.error("Error updating settings:",w),s=`Erro ao atualizar configura\xE7\xF5es: ${w.message}`):s=`Configura\xE7\xF5es atualizadas com sucesso: ${Object.keys(l).join(", ")}.`}else s="Nenhuma altera\xE7\xE3o solicitada."}}catch(n){console.error(`Error executing ${h}: `,n),s=`Erro ao executar ferramenta: ${n.message} `}z.push({role:"tool",tool_call_id:k.id,content:s})}}return X&&(await r.from("messages").insert({user_id:c,role:"assistant",content:X,is_from_me:!0,is_group:B,sender_name:_e,sender_number:ne,message_timestamp:new Date().toISOString()}),console.log("\u{1F4BE} AI Response saved to history.")),new Response(JSON.stringify({success:!0,response:X}),{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}catch(D){return console.error("Error processing message:",D),new Response(JSON.stringify({success:!1,error:D.message}),{status:500,headers:{"Content-Type":"application/json"}})}});const ue=["trip","project","finance_bucket","event_list","generic"];function pe(O,D){return ue.includes(O)?O==="trip"&&!D?.status?{valid:!1,error:"\u274C ERRO DE VALIDA\xC7\xC3O: Viagens exigem um 'status' no metadata (planning, confirmed, completed). Ex: metadata: { status: 'planning' }"}:O==="finance_bucket"&&!D?.currency?{valid:!1,error:"\u274C ERRO DE VALIDA\xC7\xC3O: Potes financeiros exigem uma 'currency' no metadata (BRL, USD, EUR). Ex: metadata: { currency: 'BRL' }"}:{valid:!0}:{valid:!1,error:`\u274C ERRO DE GOVERNAN\xC7A: O tipo de entidade '${O}' \xE9 inv\xE1lido. Os tipos permitidos s\xE3o: ${ue.join(", ")}. Corrija e tente novamente.`}}async function ve(O,D,d){if(d.action==="create"){const $=d.entity_type||"generic",c=d.metadata||{},m=pe($,c);if(!m.valid)return JSON.stringify({success:!1,error:m.error});const{data:v,error:q}=await O.from("collections").insert({user_id:D,name:d.name,description:d.description||null,icon:d.icon||"\u{1F4C1}",metadata:{entity_type:$,created_by:"ai_agent",...c}}).select().single();return JSON.stringify(q?{success:!1,error:`Database error: ${q.message}`}:{success:!0,message:`Entidade '${d.name}' criada com sucesso.`,entity:{id:v.id,name:v.name,type:$,icon:v.icon}})}else if(d.action==="list"){const{data:$}=await O.from("collections").select("name, metadata").eq("user_id",D),c=$?.map(m=>`${m.name} (${m.metadata?.entity_type||"generic"})`).join(", ")||"Nenhuma";return JSON.stringify({success:!0,collections:$})}else if(d.action==="update"){const{data:$}=await O.from("collections").select("id").eq("user_id",D).eq("name",d.name).maybeSingle();if(!$)return JSON.stringify({success:!1,error:`Pasta "${d.name}" n\xE3o encontrada.`});const c={};if(d.new_name&&(c.name=d.new_name),d.description&&(c.description=d.description),d.icon&&(c.icon=d.icon),d.entity_type){const v=pe(d.entity_type,{});if(!v.valid)return JSON.stringify({success:!1,error:v.error})}if(Object.keys(c).length===0)return JSON.stringify({success:!1,error:"Nenhuma altera\xE7\xE3o fornecida."});const{error:m}=await O.from("collections").update(c).eq("id",$.id);return JSON.stringify(m?{success:!1,error:m.message}:{success:!0,message:`Pasta "${d.name}" atualizada.`})}else if(d.action==="delete"){const{data:$}=await O.from("collections").select("id").eq("user_id",D).eq("name",d.name).maybeSingle();if(!$)return JSON.stringify({success:!1,error:`Pasta "${d.name}" n\xE3o encontrada.`});const{count:c}=await O.from("collection_items").select("*",{count:"exact",head:!0}).eq("collection_id",$.id);if(c&&c>0&&!d.force)return JSON.stringify({success:!1,error:`Pasta n\xE3o vazia (${c} itens). Use force: true para deletar.`});const{error:m}=await O.from("collections").delete().eq("user_id",D).eq("name",d.name);return JSON.stringify(m?{success:!1,error:m.message}:{success:!0,message:`Pasta "${d.name}" apagada.`})}return JSON.stringify({success:!1,error:"A\xE7\xE3o desconhecida."})}async function Ee(O,D,d){const $=d.query,c=d.limit||10,m=[],{data:v}=await O.from("collection_items").select("content, metadata, collections(name)").eq("user_id",D).or(`content.ilike.%${$}%`).limit(c);v&&v.length>0&&v.forEach(T=>{m.push(`[ITEM] Pasta: ${T.collections?.name||"?"} | ${T.content} | ${JSON.stringify(T.metadata)}`)});const{data:q}=await O.from("reminders").select("title, due_at, is_completed").eq("user_id",D).ilike("title",`%${$}%`).limit(c);return q&&q.length>0&&q.forEach(T=>{m.push(`[LEMBRETE] ${T.title} (${new Date(T.due_at).toLocaleString("pt-BR")}) [${T.is_completed?"Feito":"Pendente"}]`)}),m.length===0?`N\xE3o encontrei nada sobre "${$}" em nenhuma pasta ou lembrete.`:`Resultados para "${$}":
${m.join(`
`)}`}async function Oe(O,D,d){const $=d.limit||5,{data:c}=await O.from("collections").select("id, name, metadata, collection_items(content)").eq("user_id",D),m=c.filter(T=>!T.metadata?.entity_type||T.metadata.entity_type==="generic");if(m.length===0)return JSON.stringify({success:!0,message:"Nenhuma cole\xE7\xE3o legada encontrada."});const v=m.slice(0,$),q=[];for(const T of v){const B=T.collection_items?.slice(0,3).map(x=>x.content).join(", ")||"Vazia";q.push({id:T.id,name:T.name,current_type:T.metadata?.entity_type||"NULL",suggested_action:"REQUIRES_CLASSIFICATION",items_context:B})}return JSON.stringify({success:!0,message:`Encontradas ${m.length} cole\xE7\xF5es legadas. Mostrando ${v.length}.`,candidates:q,instruction:"Para corrigir, use 'manage_collections' com action='update' e defina o entity_type correto para cada uma."})}
