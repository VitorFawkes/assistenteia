tion==="delete_event"){let f=e.event_id;if(!f&&e.title){if(U){const u=`https://www.googleapis.com/calendar/v3/calendars/primary/events?q=${encodeURIComponent(e.title)}&timeMin=${new Date().toISOString()}&maxResults=5`,y=(await(await fetch(u,{headers:N})).json()).items||[];if(y.length===0)a.push(`[GOOGLE] N\xE3o encontrei nenhum evento futuro com o t\xEDtulo "${e.title}".`);else if(y.length>1){const A=y.map(R=>`- ${R.summary} (${new Date(R.start.dateTime||R.start.date).toLocaleString("pt-BR")}) [ID: ${R.id}]`).join(`
`);a.push(`[GOOGLE] Encontrei m\xFAltiplos eventos. Qual deles apagar?
${A}`)}else f=y[0].id}else if(G){const u=`https://graph.microsoft.com/v1.0/me/events?$filter=contains(subject,'${e.title}') and start/dateTime ge '${new Date().toISOString()}'&$top=5`,y=(await(await fetch(u,{headers:N})).json()).value||[];if(y.length===0)a.push(`[OUTLOOK] N\xE3o encontrei nenhum evento futuro com o t\xEDtulo "${e.title}".`);else if(y.length>1){const A=y.map(R=>`- ${R.subject} (${new Date(R.start.dateTime).toLocaleString("pt-BR")}) [ID: ${R.id}]`).join(`
`);a.push(`[OUTLOOK] Encontrei m\xFAltiplos eventos. Qual deles apagar?
${A}`)}else f=y[0].id}}if(!f&&!e.title)a.push("Erro: ID do evento ou T\xEDtulo necess\xE1rio para deletar.");else if(f){if(U){const u=await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${f}`,{method:"DELETE",headers:N});u.ok?a.push("[GOOGLE] Evento apagado com sucesso."):a.push(`[GOOGLE] Erro ao apagar: ${(await u.json()).error?.message}`)}else if(G){const u=await fetch(`https://graph.microsoft.com/v1.0/me/events/${f}`,{method:"DELETE",headers:N});u.ok?a.push("[OUTLOOK] Evento apagado com sucesso."):a.push(`[OUTLOOK] Erro ao apagar: ${await u.text()}`)}}}}catch(l){console.error(`Error processing Calendar ${n.provider}:`,l),a.push(`[${n.provider.toUpperCase()}] Erro: ${l.message}`)}s=a.length>0?a.join(`
`):"Nenhum evento encontrado ou a\xE7\xE3o realizada."}}else if(h==="search_contacts"){const{data:i}=await r.from("messages").select("sender_name, sender_number, created_at").eq("user_id",c).or(`sender_name.ilike.%${e.query}%,sender_number.ilike.%${e.query}%`).order("created_at",{ascending:!1}).limit(50);if(!i||i.length===0)s=`Nenhum contato encontrado com o nome "${e.query}". Tente buscar por parte do nome.`;else{const t=new Map;i.forEach(n=>{t.has(n.sender_number)||t.set(n.sender_number,{name:n.sender_name,number:n.sender_number,last_seen:n.created_at})});const a=Array.from(t.values()).sort((n,l)=>{const w=n.number.startsWith("55")&&n.number.length>=12&&n.number.length<=13,L=l.number.startsWith("55")&&l.number.length>=12&&l.number.length<=13;return w&&!L?-1:!w&&L?1:new Date(l.last_seen).getTime()-new Date(n.last_seen).getTime()}).map(n=>{const w=n.number.startsWith("55")&&n.number.length>=12&&n.number.length<=13?"[\u{1F4F1} CELULAR]":"[\u2753 OUTRO/ID]";return`- ${n.name} (${n.number}) ${w} [Visto em: ${new Date(n.last_seen).toLocaleDateString("pt-BR")}]`}).join(`
`);s=`Contatos encontrados para "${e.query}":
${a}

PREFIRA N\xDAMEROS MARCADOS COMO [\u{1F4F1} CELULAR]. Evite [\u2753 OUTRO/ID] se poss\xEDvel.`}}else if(h==="query_data"){const{data:i}=await r.from("collections").select("id").eq("user_id",c).eq("name",e.collection_name).maybeSingle();if(!i)s=`Pasta "${e.collection_name}" n\xE3o encontrada.`;else{e.start_date;const{data:t}=await r.from("collection_items").select("*").eq("collection_id",i.id).order("created_at",{ascending:!1}).limit(500);let o=t||[];if(e.start_date&&(o=o.filter(a=>(a.metadata?.date||a.created_at)>=e.start_date)),e.end_date&&(o=o.filter(a=>(a.metadata?.date||a.created_at)<=e.end_date)),e.filter_key&&e.filter_value&&(o=o.filter(a=>a.metadata?.[e.filter_key]===e.filter_value)),!o||o.length===0)s=`Nenhum dado encontrado com esses filtros em "${e.collection_name}".`;else if(e.operation==="sum"&&e.field){const a=o.reduce((l,w)=>l+(Number(w.metadata?.[e.field])||0),0),n=o.map(l=>`- ${l.content||""} (Meta: ${JSON.stringify(l.metadata||{})})`).join(`
`);s=`Total (via metadata '${e.field}'): ${a}.

Itens considerados:
${n}

(Se o total for 0, verifique os itens acima para somar manualmente)`}else if(e.operation==="count")s=`Total de itens: ${o.length} `;else if(e.operation==="average"&&e.field){const a=o.reduce((l,w)=>l+(Number(w.metadata?.[e.field])||0),0),n=o.map(l=>`- ${l.content||""} (Meta: ${JSON.stringify(l.metadata||{})})`).join(`
`);s=`M\xE9dia (via metadata '${e.field}'): ${(a/o.length).toFixed(2)}.

Itens considerados:
${n}`}else s=`Resultado: 
${o.map(n=>{const l=n.metadata?JSON.stringify(n.metadata):"";return`- ${n.content||""} ${l} `}).join(`
`)} `}}else if(h==="global_search")s=await Ee(r,c,e);else if(h==="manage_reminders"){if(e.action==="create"){const i=ee(e,x,V);if(i){const t=new Date(i),o=new Date,a=(t.getTime()-o.getTime())/(1e3*60);if(console.log(`\u{1F50D} DATE CHECK: Due = ${i}, Diff = ${a.toFixed(1)} min`),a<-5)s=`ERRO: A data calculada(${i}) est\xE1 no passado.Por favor, seja mais espec\xEDfico(ex: "amanh\xE3 \xE0s 10h").`,console.error("\u274C REJECTED: Date in past");else{const n={user_id:c,title:e.title,due_at:i,recurrence_type:e.recurrence_type||"once",is_completed:!1};e.recurrence_type&&e.recurrence_type!=="once"&&(e.recurrence_type==="custom"&&(n.recurrence_interval=e.recurrence_interval,n.recurrence_unit=e.recurrence_unit),e.recurrence_type==="weekly"&&e.weekdays&&(n.weekdays=e.weekdays),e.recurrence_count&&(n.recurrence_count=e.recurrence_count));const{error:l}=await r.from("reminders").insert(n);if(l)throw l;let w=`Lembrete "${e.title}" agendado para ${i} `;e.recurrence_type!=="once"&&(w+=` (Recorrente: ${e.recurrence_type})`),s=w}}else s="Erro: N\xE3o foi poss\xEDvel calcular a data do lembrete. Tente novamente."}else if(e.action==="list"){const{data:i}=await r.from("reminders").select("*").eq("user_id",c).eq("is_completed",!1).order("due_at");s=`Lembretes pendentes: ${i?.map(t=>`[ID: ${t.id}] ${t.title} (${t.due_at})`).join(", ")||"Nenhum"} `}else if(e.action==="complete")if(e.id)await r.from("reminders").update({is_completed:!0}).eq("id",e.id).eq("user_id",c),s=`Lembrete marcado como conclu\xEDdo (ID: ${e.id}).`;else{const i=e.search_title||e.title,{data:t}=await r.from("reminders").select("id, title, due_at").eq("user_id",c).eq("is_completed",!1).ilike("title",`%${i}%`);if(t&&t.length===1)await r.from("reminders").update({is_completed:!0}).eq("id",t[0].id),s=`Lembrete "${t[0].title}" marcado como conclu\xEDdo.`;else if(t&&t.length>1)s=`Encontrei m\xFAltiplos lembretes pendentes com esse nome. Qual deles voc\xEA quer concluir?
${t.map(a=>`- ${a.title} (${new Date(a.due_at).toLocaleString("pt-BR")}) [ID: ${a.id}]`).join(`
`)}

Por favor, repita o comando usando o ID ou o nome mais espec\xEDfico.`;else{const{data:o}=await r.from("reminders").select("id, title").eq("user_id",c).eq("is_completed",!0).ilike("title",`%${i}%`).limit(1);o&&o.length>0?s=`O lembrete "${o[0].title}" j\xE1 estava conclu\xEDdo.`:s=`N\xE3o encontrei nenhum lembrete chamado "${i}".`}}else if(e.action==="update"){let i=null;if(e.id){const{data:t}=await r.from("reminders").select("*").eq("id",e.id).eq("user_id",c).single();i=t}else{const t=e.title,{data:o}=await r.from("reminders").select("*").eq("user_id",c).eq("is_completed",!1).ilike("title",`%${t}%`).limit(5);if(o&&o.length===1)i=o[0];else if(o&&o.length>1)s=`Encontrei m\xFAltiplos lembretes pendentes. Qual deles alterar?
${o.map(n=>`- ${n.title} (${new Date(n.due_at).toLocaleString("pt-BR")}) [ID: ${n.id}]`).join(`
`)}`;else{const{data:a}=await r.from("reminders").select("*").eq("user_id",c).ilike("title",`%${t}%`).limit(1);i=a?.[0]}}if(!i&&!s)s="Erro: Lembrete n\xE3o encontrado para atualiza\xE7\xE3o.";else if(i){const t={};if(e.title&&(t.title=e.title),e.time_config||e.relative_time||V){const a=ee(e,x,V);a&&(t.due_at=a)}e.recurrence_type&&(t.recurrence_type=e.recurrence_type),e.recurrence_interval&&(t.recurrence_interval=e.recurrence_interval),e.recurrence_unit&&(t.recurrence_unit=e.recurrence_unit),e.weekdays&&(t.weekdays=e.weekdays),e.recurrence_count&&(t.recurrence_count=e.recurrence_count);const{error:o}=await r.from("reminders").update(t).eq("id",i.id);if(o)throw o;s="Lembrete atualizado com sucesso."}}else if(e.action==="delete"){let i=null;if(e.id)i={id:e.id};else{const t=e.search_title||e.title,{data:o}=await r.from("reminders").select("id, title, due_at").eq("user_id",c).eq("is_completed",!1).ilike("title",`%${t}%`).limit(5);if(o&&o.length===1)i=o[0];else if(o&&o.length>1)s=`Encontrei m\xFAltiplos lembretes pendentes. Qual deles apagar?
${o.map(n=>`- ${n.title} (${new Date(n.due_at).toLocaleString("pt-BR")}) [ID: ${n.id}]`).join(`
`)}`;else{const{data:a}=await r.from("reminders").select("id, title").eq("user_id",c).ilike("title",`%${t}%`).limit(1);i=a?.[0]}}!i&&!s?s="Erro: Lembrete n\xE3o encontrado para apagar.":i&&(await r.from("reminders").delete().eq("id",i.id).eq("user_id",c),s=`Lembrete apagado (ID: ${i.id}).`)}}else if(h==="manage_tasks"){if(e.action==="create"){const i=ee(e,x,null),{error:t}=await r.from("tasks").insert({user_id:c,title:e.title,description:e.description||null,priority:e.priority||"medium",status:e.status||"todo",tags:e.tags||[],due_date:i});if(t)throw t;const o=i?` para ${new Date(i).toLocaleDateString("pt-BR")}`:"";s=`Tarefa "${e.title}" adicionada \xE0 lista${o}.`}else if(e.action==="list"){let i=r.from("tasks").select("*").eq("user_id",c);e.filter_status?i=i.eq("status",e.filter_status):i=i.neq("status","done").neq("status","archived");const{data:t}=await i.order("created_at",{ascending:!1});if(!t||t.length===0)s="Nenhuma tarefa encontrada.";else{let o=t;if(e.filter_date==="today"){const a=x.toISOString().split("T")[0];o=t.filter(n=>{if(!n.due_date)return!1;const l=n.due_date.split("T")[0];return l===a||l<a&&n.status!=="done"})}else if(e.filter_date==="tomorrow"){const a=new Date(x);a.setDate(a.getDate()+1);const n=a.toISOString().split("T")[0];o=t.filter(l=>l.due_date&&l.due_date.startsWith(n))}o.length===0?s=`Nenhuma tarefa encontrada para "${e.filter_date||"filtro atual"}".`:s=`Suas Tarefas:
${o.map(a=>{const n=a.due_date?` [\u{1F4C5} ${new Date(a.due_date).toLocaleDateString("pt-BR")}]`:"";return`- [${a.status.toUpperCase()}] ${a.title} (${a.priority})${n}`}).join(`
`)}`}}else if(e.action==="update"||e.action==="complete"||e.action==="delete"){let i=r.from("tasks").select("id, title, status").eq("user_id",c);e.action==="complete"||e.action,e.search_title&&(i=i.ilike("title",`%${e.search_title}%`));const{data:t}=await i.limit(5);let o=null;if(t&&t.length>0&&(e.action==="complete"&&(o=t.find(a=>a.status!=="done"&&a.status!=="archived")),o||(o=t[0])),!o)s=`Erro: Tarefa "${e.search_title}" n\xE3o encontrada.`;else if(e.action==="complete"&&o.status==="done")s=`A tarefa "${o.title}" j\xE1 estava conclu\xEDda!`;else if(e.action==="delete")await r.from("tasks").delete().eq("id",o.id),s=`Tarefa "${o.title}" apagada.`;else if(e.action==="complete")await r.from("tasks").update({status:"done",completed_at:new Date().toISOString()}).eq("id",o.id),s=`Tarefa "${o.title}" marcada como conclu\xEDda! \u{1F389}`;else{const a={};if(e.title&&(a.title=e.title),e.description&&(a.description=e.description),e.priority&&(a.priority=e.priority),e.status&&(a.status=e.status),e.tags&&(a.tags=e.tags),e.due_date||e.time_config||e.relative_time){const n=ee(e,x,null);n&&(a.due_date=n)}await r.from("tasks").update(a).eq("id",o.id),s=`Tarefa "${o.title}" atualizada.`}}}else if(h==="save_memory"){console.log(`\u{1F9E0} Saving memory: "${e.content}"`);const t=await(await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},body:JSON.stringify({model:"text-embedding-3-small",input:e.content})})).json(),o=t.data?.[0]?.embedding;if(!o)console.error("\u274C OpenAI Embedding Error:",JSON.stringify(t)),s=`Erro ao gerar vetor: ${JSON.stringify(t)}`;else{const{error:a}=await r.from("memories").insert({user_id:c,content:e.content,embedding:o,metadata:{category:e.category||"general"}});if(a)throw a;s="Mem\xF3ria salva com sucesso! \u{1F9E0}"}}else if(h==="recall_memory"){console.log(`\u{1F9E0} Recalling memory for: "${e.query}"`);const o=(await(await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${F}`,"Content-Type":"application/json"},body:JSON.stringify({model:"text-embedding-3-small",input:e.query})})).json()).data?.[0]?.embedding;if(!o)s="Erro ao gerar vetor de busca.";else{const{data:a,error:n}=await r.rpc("match_memories",{query_embedding:o,match_threshold:.5,match_count:e.match_count||5,p_user_id:c});n?(console.error("\u274C Match Error:",n),s="Erro ao buscar mem\xF3rias."):!a||a.length===0?s="Nenhuma mem\xF3ria relevante encontrada.":s=`Mem\xF3rias Encontradas:
${a.map(w=>`- ${w.content} (Similaridade: ${(w.similarity*100).toFixed(0)}%)`).join(`
`)}`}}else if(h==="send_whatsapp_message"){if(M?.privacy_allow_outgoing===!1)throw console.warn("\u{1F6D1} BLOCKED OUTGOING MESSAGE: User disabled outgoing messages."),new Error("\u26D4 A\xE7\xE3o Bloqueada: Voc\xEA configurou sua privacidade para N\xC3O permitir que a IA envie mensagens para outras pessoas.");console.log(`\u{1F4E4} Sending WhatsApp message to ${e.number}`);const i=e.number.replace(/\D/g,""),t=i.includes("@")?i:`${i}@s.whatsapp.net`,o=Deno.env.get("EVOLUTION_API_URL"),a=Deno.env.get("EVOLUTION_API_KEY"),{data:n}=await r.from("whatsapp_instances").select("instance_name").eq("user_id",c).eq("status","connected").limit(1),l=n?.[0]?.instance_name||"user_personal";console.log(`\u{1F4E4} Sending WhatsApp message to ${t} via ${l}`);let w;e.media_url?(console.log(`\u{1F4CE} Sending Media: ${e.media_url}`),w=await fetch(`${o}/message/sendMedia/${l}`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a},body:JSON.stringify({number:t,options:{delay:1200},mediaMessage:{mediatype:e.media_type||"image",media:e.media_url,caption:e.message||""}})})):w=await fetch(`${o}/message/sendText/${l}`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a},body:JSON.stringify({number:t,options:{delay:1200},text:e.message})});const L=await w.text();w.ok?(console.log("\u2705 Outgoing message sent!"),await r.from("debug_logs").insert({function_name:"process-message",level:"info",message:"Outgoing WhatsApp message sent",meta:{number:t,instance:l,hasMedia:!!e.media_url}}),s=`Mensagem enviada com sucesso para ${e.number}.`):(console.error("\u274C Failed to send outgoing message:",L),await r.from("debug_logs").insert({function_name:"process-message",level:"error",message:"Failed to send WhatsApp message",meta:{error:L,number:t,instance:l}}),s=`Erro ao enviar mensagem: ${L}`)}else if(h==="query_messages"){const i=e.limit||20,t=e.days_ago||7,o=Deno.env.get("ENCRYPTION_KEY");if(!o)console.error("\u274C CRITICAL: ENCRYPTION_KEY not set. Cannot decrypt messages."),s="Erro: Chave de criptografia n\xE3o configurada. N\xE3o consigo ler o hist\xF3rico.";else{const{data:a,error:n}=await r.rpc("get_messages_decrypted",{p_encryption_key:o,p_limit:i,p_offset:0,p_user_id:c,p_sender_number:e.sender_number||null,p_group_name:e.group_name||null,p_days_ago:t});n?(console.error("\u274C Error fetching decrypted messages:",n),s=`Erro ao buscar mensagens: ${n.message}`):!a||a.length===0?s="Nenhuma mensagem encontrada com esses crit\xE9rios.":s=a.map(l=>`[${new Date(l.created_at).toLocaleString("pt-BR")}] ${l.sender_name||l.sender_number}: ${l.content} ${l.media_type?`[${l.media_type}]`:""}`).reverse().join(`
`)}}else if(h==="migrate_legacy_collections")s=await be(r,c,e);else if(h==="update_user_settings"){const{preferred_name:i,daily_briefing_enabled:t,daily_briefing_time:o,daily_briefing_prompt:a,ai_name:n}=e,l={};if(i&&(l.preferred_name=i),t!==void 0&&(l.daily_briefing_enabled=t),o&&(l.daily_briefing_time=o),e.daily_briefing_prompt!==void 0&&(l.daily_briefing_prompt=e.daily_briefing_prompt),e.ai_name!==void 0&&(l.ai_name=e.ai_name),Object.keys(l).length>0){const{error:w}=await r.from("user_settings").update(l).eq("user_id",c);w?(console.error("Error updating settings:",w),s=`Erro ao atualizar configura\xE7\xF5es: ${w.message}`):s=`Configura\xE7\xF5es atualizadas com sucesso: ${Object.keys(l).join(", ")}.`}else s="Nenhuma altera\xE7\xE3o solicitada."}}catch(i){console.error(`Error executing ${h}: `,i),s=`Erro ao executar ferramenta: ${i.message} `}z.push({role:"tool",tool_call_id:k.id,content:s})}}return X&&(await r.from("messages").insert({user_id:c,role:"assistant",content:X,is_from_me:!0,is_group:B,sender_name:_e,sender_number:ne,message_timestamp:new Date().toISOString()}),console.log("\u{1F4BE} AI Response saved to history.")),new Response(JSON.stringify({success:!0,response:X}),{headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}catch(D){return console.error("Error processing message:",D),new Response(JSON.stringify({success:!1,error:D.message}),{status:500,headers:{"Content-Type":"application/json"}})}});const ue=["trip","project","finance_bucket","event_list","generic"];function pe(b,D){return ue.includes(b)?b==="trip"&&!D?.status?{valid:!1,error:"\u274C ERRO DE VALIDA\xC7\xC3O: Viagens exigem um 'status' no metadata (planning, confirmed, completed). Ex: metadata: { status: 'planning' }"}:b==="finance_bucket"&&!D?.currency?{valid:!1,error:"\u274C ERRO DE VALIDA\xC7\xC3O: Potes financeiros exigem uma 'currency' no metadata (BRL, USD, EUR). Ex: metadata: { currency: 'BRL' }"}:{valid:!0}:{valid:!1,error:`\u274C ERRO DE GOVERNAN\xC7A: O tipo de entidade '${b}' \xE9 inv\xE1lido. Os tipos permitidos s\xE3o: ${ue.join(", ")}. Corrija e tente novamente.`}}async function ve(b,D,d){if(d.action==="create"){const $=d.entity_type||"generic",c=d.metadata||{},m=pe($,c);if(!m.valid)return JSON.stringify({success:!1,error:m.error});const{data:v,error:q}=await b.from("collections").insert({user_id:D,name:d.name,description:d.description||null,icon:d.icon||"\u{1F4C1}",metadata:{entity_type:$,created_by:"ai_agent",...c}}).select().single();return JSON.stringify(q?{success:!1,error:`Database error: ${q.message}`}:{success:!0,message:`Entidade '${d.name}' criada com sucesso.`,entity:{id:v.id,name:v.name,type:$,icon:v.icon}})}else if(d.action==="list"){const{data:$}=await b.from("collections").select("name, metadata").eq("user_id",D),c=$?.map(m=>`${m.name} (${m.metadata?.entity_type||"generic"})`).join(", ")||"Nenhuma";return JSON.stringify({success:!0,collections:$})}else if(d.action==="update"){const{data:$}=await b.from("collections").select("id").eq("user_id",D).eq("name",d.name).maybeSingle();if(!$)return JSON.stringify({success:!1,error:`Pasta "${d.name}" n\xE3o encontrada.`});const c={};if(d.new_name&&(c.name=d.new_name),d.description&&(c.description=d.description),d.icon&&(c.icon=d.icon),d.entity_type){const v=pe(d.entity_type,{});if(!v.valid)return JSON.stringify({success:!1,error:v.error})}if(Object.keys(c).length===0)return JSON.stringify({success:!1,error:"Nenhuma altera\xE7\xE3o fornecida."});const{error:m}=await b.from("collections").update(c).eq("id",$.id);return JSON.stringify(m?{success:!1,error:m.message}:{success:!0,message:`Pasta "${d.name}" atualizada.`})}else if(d.action==="delete"){const{data:$}=await b.from("collections").select("id").eq("user_id",D).eq("name",d.name).maybeSingle();if(!$)return JSON.stringify({success:!1,error:`Pasta "${d.name}" n\xE3o encontrada.`});const{count:c}=await b.from("collection_items").select("*",{count:"exact",head:!0}).eq("collection_id",$.id);if(c&&c>0&&!d.force)return JSON.stringify({success:!1,error:`Pasta n\xE3o vazia (${c} itens). Use force: true para deletar.`});const{error:m}=await b.from("collections").delete().eq("user_id",D).eq("name",d.name);return JSON.stringify(m?{success:!1,error:m.message}:{success:!0,message:`Pasta "${d.name}" apagada.`})}return JSON.stringify({success:!1,error:"A\xE7\xE3o desconhecida."})}async function Ee(b,D,d){const $=d.query,c=d.limit||10,m=[],{data:v}=await b.from("collection_items").select("content, metadata, collections(name)").eq("user_id",D).or(`content.ilike.%${$}%`).limit(c);v&&v.length>0&&v.forEach(T=>{m.push(`[ITEM] Pasta: ${T.collections?.name||"?"} | ${T.content} | ${JSON.stringify(T.metadata)}`)});const{data:q}=await b.from("reminders").select("title, due_at, is_completed").eq("user_id",D).ilike("title",`%${$}%`).limit(c);return q&&q.length>0&&q.forEach(T=>{m.push(`[LEMBRETE] ${T.title} (${new Date(T.due_at).toLocaleString("pt-BR")}) [${T.is_completed?"Feito":"Pendente"}]`)}),m.length===0?`N\xE3o encontrei nada sobre "${$}" em nenhuma pasta ou lembrete.`:`Resultados para "${$}":
${m.join(`
`)}`}async function be(b,D,d){const $=d.limit||5,{data:c}=await b.from("collections").select("id, name, metadata, collection_items(content)").eq("user_id",D),m=c.filter(T=>!T.metadata?.entity_type||T.metadata.entity_type==="generic");if(m.length===0)return JSON.stringify({success:!0,message:"Nenhuma cole\xE7\xE3o legada encontrada."});const v=m.slice(0,$),q=[];for(const T of v){const B=T.collection_items?.slice(0,3).map(P=>P.content).join(", ")||"Vazia";q.push({id:T.id,name:T.name,current_type:T.metadata?.entity_type||"NULL",suggested_action:"REQUIRES_CLASSIFICATION",items_context:B})}return JSON.stringify({success:!0,message:`Encontradas ${m.length} cole\xE7\xF5es legadas. Mostrando ${v.length}.`,candidates:q,instruction:"Para corrigir, use 'manage_collections' com action='update' e defina o entity_type correto para cada uma."})}
